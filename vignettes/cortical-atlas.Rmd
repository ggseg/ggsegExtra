---
title: "Creating cortical atlases"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating cortical atlases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

Cortical atlases represent parcellations of the brain surface.
They come from FreeSurfer annotation files that assign each vertex on the cortical mesh to a labelled region.
This tutorial shows how to turn an annotation into a brain atlas you can plot with ggseg and ggseg3d.

```{r}
#| label: load-libraries
library(ggsegExtra)
library(ggseg)
library(ggseg3d)
library(ggplot2)
library(dplyr)
```

## The fast path: 3D only

If you only need 3D visualisation, skip the 2D polygon extraction entirely:

```{r}
#| label: 3d-only
atlas <- create_cortical_atlas(
  annot = "aparc.DKTatlas",
  include_geometry = FALSE
)

ggseg3d(atlas = atlas, hemisphere = "left") |>
  pan_camera("left lateral")
```

This reads the annotation file, extracts which vertices belong to each region, and returns in seconds.
The atlas works with ggseg3d but not ggseg (no 2D polygons).

## Full atlas with 2D geometry

For 2D plots, you need the polygon extraction pipeline:

```{r}
#| label: full-atlas
output_dir <- withr::local_tempdir()

atlas <- create_cortical_atlas(
  annot = "aparc.DKTatlas",
  include_geometry = TRUE,
  output_dir = output_dir,
  view = c("lateral", "medial"),
  smoothness = 5,
  tolerance = 0
)

plot(atlas)
```

The function takes screenshots of each region from each view, extracts contours, and converts them to polygons.
This takes longer but gives you both 2D and 3D capabilities.

## Working with custom annotations

If your annotation files are not in FreeSurfer's default location, point to them directly:

```{r}
#| label: custom-dir
atlas <- create_cortical_atlas(
  annot = "myatlas",
  input_dir = "path/to/annotations",
  include_geometry = TRUE
)
```

The directory should contain `lh.myatlas.annot` and `rh.myatlas.annot`.

If you need to convert an annotation from a different subject to fsaverage5 first:

```{r}
#| label: convert-annot
mri_surf2surf_rereg(
  subject = "bert",
  annot = "aparc.DKTatlas",
  hemi = "lh",
  output_dir = "path/to/output"
)

mri_surf2surf_rereg(
  subject = "bert",
  annot = "aparc.DKTatlas",
  hemi = "rh",
  output_dir = "path/to/output"
)
```

## Choosing views

The `view` parameter controls which angles appear in 2D plots:

```{r}
#| label: views
atlas_minimal <- create_cortical_atlas(
  annot = "aparc",
  view = c("lateral", "medial"),
  include_geometry = TRUE
)

atlas_complete <- create_cortical_atlas(
  annot = "aparc",
  view = c("lateral", "medial", "superior", "inferior"),
  include_geometry = TRUE
)
```

More views means more screenshots and longer processing.
Start with lateral and medial; add others if you need them.

## Tuning polygon quality

Two parameters control how the 2D polygons look:

**smoothness** controls contour smoothing.
Higher values produce rounder edges but may lose detail in small regions.
Default is 5.

**tolerance** controls vertex reduction.
Higher values produce simpler polygons with fewer vertices (smaller file size, faster plotting) but may lose shape fidelity.
Default is 0 (no reduction).

```{r}
#| label: tuning
atlas_detailed <- create_cortical_atlas(
  annot = "aparc",
  smoothness = 2,
  tolerance = 0,
  include_geometry = TRUE
)

atlas_simplified <- create_cortical_atlas(
  annot = "aparc",
  smoothness = 5,
  tolerance = 0.8,
  include_geometry = TRUE
)
```

Finding the right balance takes iteration.
Set `cleanup = FALSE` to keep intermediate files and re-run later steps without redoing screenshots:

```{r}
#| label: iterate
output_dir <- "~/Desktop/my_atlas"

atlas <- create_cortical_atlas(
  annot = "aparc",
  output_dir = output_dir,
  cleanup = FALSE,
  include_geometry = TRUE
)

nrow(atlas$data$sf)
```

Check the vertex count.
If it is too high (making plots slow), increase tolerance.
If shapes look blocky, decrease it.

## Cleaning region names

The atlas inherits region names from the annotation file.
These are often technical labels that don't read well in plots.
Clean them after creation:

```{r}
#| label: clean-names
atlas$core <- atlas$core |>
  mutate(
    region = gsub("_", " ", region),
    region = gsub("ctx-lh-", "", region),
    region = gsub("ctx-rh-", "", region)
  )

plot(atlas)
```

## Parallel processing

For atlases with many regions, enable parallel processing:

```{r}
#| label: parallel
library(future)
plan(multisession, workers = 4)

library(progressr)
handlers("cli")
handlers(global = TRUE)

atlas <- create_cortical_atlas(
  annot = "aparc.a2009s",
  include_geometry = TRUE
)

plan(sequential)
```

## Debugging

When things go wrong, check these common issues:

**No regions found**: The annotation file exists but contains no labelled vertices.
Verify the file with FreeSurfer's `freeview`.

**Empty polygons for some regions**: Small regions may not appear at certain view angles.
Try adding more views or using a higher-resolution surface.

**Polygons look wrong**: The smoothness or tolerance settings may be too aggressive.
Try lower values and compare to the 3D rendering.

**Colours don't match expectations**: The palette comes from the annotation file's colour table.
You can override it:

```{r}
#| label: palette
atlas$palette["lh_precuneus"] <- "#FF0000"
atlas$palette["rh_precuneus"] <- "#FF0000"
```

## Complete example: DKT atlas

Here is the full pipeline for creating the DKT atlas:

```{r}
#| label: dkt-complete
library(ggsegExtra)
library(dplyr)

output_dir <- withr::local_tempdir()

mri_surf2surf_rereg(
  subject = "bert",
  annot = "aparc.DKTatlas",
  hemi = "lh",
  output_dir = output_dir
)

mri_surf2surf_rereg(
  subject = "bert",
  annot = "aparc.DKTatlas",
  hemi = "rh",
  output_dir = output_dir
)

dkt <- create_cortical_atlas(
  annot = "aparc.DKTatlas",
  input_dir = output_dir,
  output_dir = output_dir,
  include_geometry = TRUE,
  view = c("lateral", "medial"),
  smoothness = 2,
  tolerance = 0.5
)

dkt$core <- dkt$core |>
  mutate(
    region = gsub("temporal", " temporal", region),
    region = gsub("caudal", "caudal ", region),
    region = gsub("rostral", "rostral ", region),
    region = gsub("middle", "middle ", region),
    region = gsub("rior", "rior ", region),
    region = gsub("cingulate", " cingulate", region),
    region = gsub("  ", " ", region)
  )

plot(dkt)

ggseg3d(atlas = dkt, hemisphere = "left") |>
  pan_camera("left lateral")
```
