---
title: "Tutorial: Creating a tract atlas"
format: html
---

```{r}
#| label: setup
#| include: false
can_run <- set_tutorial_options()
```

Tract atlases represent white matter pathways derived from diffusion MRI tractography.
Unlike cortical or subcortical atlases where regions are contiguous surfaces, tracts are tube-like structures that follow streamline bundles through the brain.

The pipeline reads tractography files, computes a centerline for each tract, wraps it in a tube mesh, and (optionally) creates 2D projection views.

This tutorial recreates the TRACULA atlas --- the same pipeline behind `data-raw/make_tracula_atlas.R` in ggseg.formats.

## What you need

- FreeSurfer installed with TRACULA training data (`trctrain/`)
- ImageMagick for 2D geometry extraction
- Chrome/Chromium for 3D screenshots

```{r}
#| label: load-libraries
#| eval: !expr can_run
library(ggsegExtra)
library(ggseg.formats)
library(dplyr)
```

## Finding tractography files

TRACULA training data ships with FreeSurfer in the `trctrain/` directory.
Each `.trk` file contains streamlines for one tract:

```{r}
#| label: setup-paths
#| eval: !expr can_run
fs_dir <- freesurfer::fs_dir()
tract_dir <- file.path(fs_dir, "trctrain", "hcp", "mgh_1017", "mni")

tract_files <- list.files(tract_dir, pattern = "\\.trk$", full.names = TRUE)
aseg_file <- file.path(tract_dir, "aparc+aseg.nii.gz")

length(tract_files)
```

The `aparc+aseg.nii.gz` provides cortex outlines for 2D projections.
If it's missing, you can still create a 3D-only atlas.

## Creating the atlas

`create_tract_atlas()` reads each tractography file, computes a centerline, and generates a tube mesh around it.
The `input_aseg` provides cortex context for 2D views:

```{r}
#| label: create-atlas
#| eval: !expr can_run

tracula_raw <- create_tract_atlas(
  input_tracts = tract_files,
  input_aseg = aseg_file,
  atlas_name = "tracula"
)

tracula_raw
```

Key parameters:

- **`tube_radius`** controls tube thickness. Larger values make tracts more visible at the cost of anatomical precision.
- **`tube_segments`** controls the number of vertices around the tube circumference. Six gives hexagonal cross-sections; 12+ gives smoother tubes.
- **`n_points`** controls centerline resolution. More points capture finer curvature.

## Post-processing

### Selecting views

Keep the projections that show your tracts best:

```{r}
#| label: select-views
#| eval: !expr can_run
tracula_raw <- tracula_raw |>
  atlas_view_keep(c(
    "axial_2",
    "axial_4",
    "coronal_3",
    "coronal_4",
    "sagittal"
  ))
```

### Setting context regions

Add cortex as a background outline:

```{r}
#| label: context
#| eval: !expr can_run
tracula_raw <- tracula_raw |>
  atlas_region_contextual("cortex")
```

### Removing small fragments

After view selection, some tracts may appear as tiny slivers in certain views.
Remove fragments below a minimum area:

```{r}
#| label: remove-small
#| eval: !expr can_run
tracula_raw <- tracula_raw |>
  atlas_view_remove_region_small(
    min_area = 500,
    views = c("axial", "coronal")
  ) |>
  atlas_view_remove_region_small(min_area = 50)
```

The first call applies a higher threshold to axial and coronal views (where tracts appear in cross-section and produce small dots).
The second call applies a lower threshold everywhere to catch remaining slivers.

## Adding metadata

Join tract group information --- which tracts are projection fibres, which are commissural, which are association:

```{r}
#| label: metadata
#| eval: !expr can_run
normalize_label <- function(x) {
  x |>
    basename() |>
    tools::file_path_sans_ext()
}

tracula_metadata <- data.frame(
  label_key = c(
    "lh.cst.bbr.prep", "rh.cst.bbr.prep",
    "lh.ilf.bbr.prep", "rh.ilf.bbr.prep",
    "lh.unc.bbr.prep", "rh.unc.bbr.prep",
    "lh.atr.bbr.prep", "rh.atr.bbr.prep",
    "lh.cab.bbr.prep", "rh.cab.bbr.prep",
    "lh.slfp.bbr.prep", "rh.slfp.bbr.prep",
    "lh.slft.bbr.prep", "rh.slft.bbr.prep",
    "lh.ccg.bbr.prep", "rh.ccg.bbr.prep",
    "fmajor.bbr.prep", "fminor.bbr.prep"
  ),
  region = c(
    "corticospinal tract", "corticospinal tract",
    "inferior longitudinal fasciculus", "inferior longitudinal fasciculus",
    "uncinate fasciculus", "uncinate fasciculus",
    "anterior thalamic radiation", "anterior thalamic radiation",
    "cingulum (angular bundle)", "cingulum (angular bundle)",
    "SLF (parietal)", "SLF (parietal)",
    "SLF (temporal)", "SLF (temporal)",
    "cingulum (cingulate gyrus)", "cingulum (cingulate gyrus)",
    "forceps major", "forceps minor"
  ),
  group = c(
    "projection", "projection",
    "association", "association",
    "association", "association",
    "projection", "projection",
    "limbic", "limbic",
    "association", "association",
    "association", "association",
    "limbic", "limbic",
    "commissural", "commissural"
  )
)

core_with_meta <- tracula_raw$core |>
  mutate(label_key = normalize_label(label)) |>
  left_join(
    tracula_metadata |> select(label_key, region_pretty = region, group),
    by = "label_key"
  ) |>
  mutate(region = coalesce(region_pretty, region)) |>
  select(hemi, region, label, group)
```

## Rebuilding and saving

```{r}
#| label: rebuild
#| eval: !expr can_run
tracula <- brain_atlas(
  atlas = "tracula",
  type = "tract",
  palette = tracula_raw$palette,
  core = core_with_meta,
  data = tracula_raw$data
)

tracula
```

```{r}
#| label: inspect
#| eval: !expr can_run
brain_labels(tracula)

table(tracula$core$group, useNA = "ifany")
```
