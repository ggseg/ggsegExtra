---
title: "Pipeline configuration"
format: html
vignette: >
  %\VignetteIndexEntry{Pipeline configuration}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
library(ggsegExtra)
```

The atlas creation functions share common parameters that control pipeline behaviour.
You can set these explicitly in each function call, globally via R options, or through environment variables.

## Parameter hierarchy

Parameters resolve in this order:

1. **Explicit argument** --- value passed directly to the function
2. **R option** --- value from `options()`
3. **Environment variable** --- value from `Sys.getenv()`
4. **Default** --- built-in default value

This lets you set project-wide defaults while still overriding them for specific calls.

## Available options

| Parameter | R Option | Environment Variable | Default |
|-----------|----------|---------------------|---------|
| `verbose` | `ggsegExtra.verbose` | `GGSEGEXTRA_VERBOSE` | `TRUE` |
| `cleanup` | `ggsegExtra.cleanup` | `GGSEGEXTRA_CLEANUP` | `TRUE` |
| `skip_existing` | `ggsegExtra.skip_existing` | `GGSEGEXTRA_SKIP_EXISTING` | `TRUE` |
| `tolerance` | `ggsegExtra.tolerance` | `GGSEGEXTRA_TOLERANCE` | `1` |
| `smoothness` | `ggsegExtra.smoothness` | `GGSEGEXTRA_SMOOTHNESS` | `5` |

## Setting options in R

Use `options()` to set defaults for your R session:

```{r}
#| label: set-options
#| eval: false
options(
  ggsegExtra.tolerance = 0.5,
  ggsegExtra.smoothness = 10,
  ggsegExtra.cleanup = FALSE
)

atlas <- create_cortical_atlas(
  input_annot = c("lh.aparc.annot", "rh.aparc.annot"),
  output_dir = "my_atlas"
)
```

### Verbosity

The `verbose` parameter controls progress messages during pipeline execution.

```{r}
#| label: verbose
#| eval: false
options(ggsegExtra.verbose = FALSE)

Sys.setenv(GGSEGEXTRA_VERBOSE = "false")
```

### Cleanup

The `cleanup` parameter controls whether intermediate files (screenshots, contour images) are removed after pipeline completion.
Set it to `FALSE` to keep them for debugging:

```{r}
#| label: cleanup
#| eval: false
options(ggsegExtra.cleanup = FALSE)

atlas <- create_subcortical_atlas(
  input_volume = "aseg.mgz",
  output_dir = "my_atlas_files"
)
```

### Skip existing

The `skip_existing` parameter lets you resume interrupted pipeline runs by reusing existing intermediate files:

```{r}
#| label: skip-existing
#| eval: false
options(ggsegExtra.skip_existing = FALSE)

options(ggsegExtra.skip_existing = TRUE)
```

### Geometry parameters

The `tolerance` and `smoothness` parameters control the quality of 2D polygon geometry.

Higher tolerance means fewer vertices --- smaller file size, less detail.
Higher smoothness means rounder region boundaries.

```{r}
#| label: geometry
#| eval: false
options(ggsegExtra.tolerance = 1.0)

options(ggsegExtra.smoothness = 15)
```

## Environment variables

Environment variables are useful for CI pipelines, Docker containers, or settings that should persist across R sessions.

In `.Renviron`:

```
GGSEGEXTRA_VERBOSE=false
GGSEGEXTRA_CLEANUP=true
GGSEGEXTRA_SKIP_EXISTING=true
GGSEGEXTRA_TOLERANCE=0.5
GGSEGEXTRA_SMOOTHNESS=10
```

In a shell:

```bash
export GGSEGEXTRA_VERBOSE=false
export GGSEGEXTRA_TOLERANCE=0.5
R -e "ggsegExtra::create_cortical_atlas(...)"
```

In Docker:

```dockerfile
ENV GGSEGEXTRA_VERBOSE=false
ENV GGSEGEXTRA_CLEANUP=true
```

## Overriding defaults

Explicit arguments always win:

```{r}
#| label: override
#| eval: false
options(ggsegExtra.cleanup = TRUE)

atlas <- create_cortical_atlas(
  input_annot = c("lh.aparc.annot", "rh.aparc.annot"),
  cleanup = FALSE
)
```

## Recipes

### Development and debugging

```{r}
#| label: dev-options
#| eval: false
options(
  ggsegExtra.verbose = TRUE,
  ggsegExtra.cleanup = FALSE,
  ggsegExtra.skip_existing = FALSE
)
```

### Production and CI

```{r}
#| label: prod-options
#| eval: false
options(
  ggsegExtra.verbose = FALSE,
  ggsegExtra.cleanup = TRUE,
  ggsegExtra.skip_existing = TRUE
)
```

### Iterating on geometry

When fine-tuning `tolerance` and `smoothness`, disable cleanup and use step-based execution.
Run the full pipeline once to generate screenshots, then re-run only the geometry steps with different parameters:

```{r}
#| label: iterate
#| eval: false
options(ggsegExtra.cleanup = FALSE)

annot_files <- c("lh.myatlas.annot", "rh.myatlas.annot")

atlas <- create_cortical_atlas(
  input_annot = annot_files,
  output_dir = "atlas_workdir"
)

atlas <- create_cortical_atlas(
  input_annot = annot_files,
  output_dir = "atlas_workdir",
  steps = 6:8,
  smoothness = 8,
  tolerance = 0.3
)
```

This skips the slow screenshot steps and only regenerates polygons from existing contour images.
