---
title: "Contributing an atlas package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Contributing an atlas package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
library(ggsegExtra)
```

ggseg atlases live in their own R packages, distributed through the [ggseg r-universe](https://ggseg.r-universe.dev).
This provides a single place for all ggseg-compatible packages, whether hosted on GitHub, GitLab, or elsewhere.

If you have a working atlas and want it available through r-universe, follow these steps.

## Requirements

1. The data must work with ggseg, ggseg3d, or both.
2. The data must be in its own R package.
3. The R package must be hosted in a public version control repository (GitHub, GitLab, etc.).
4. The package must pass `R CMD check` without errors.

## Setting up the package repository

Since setting up a data package can be tricky, we provide a function to get you started.
It includes tests and the general structure we expect from a ggseg-atlas package.
If you already make R packages comfortably, skip this step.

To create a ggseg repo, use the RStudio New Project creation GUI and look for the ggseg icon.

### Edit DESCRIPTION

The DESCRIPTION file contains important metadata about your package.
You need to edit it for several reasons:

- List yourself (and collaborators) as authors and maintainers.
  Remove the template authors and add your own names.
  ORCID is optional.
- Update the `Description:` section to reflect your package contents.
- Change `URL:` and `BugReports` to point to your remote repository.
  If your host doesn't support issues, delete `BugReports` entirely.

### Add data

Place your atlas files as `.rda` files in the `data/` folder.
The data object must have the same name as the file.

For example, `cc200.rda` should load an object called `cc200` using `load("data/cc200.rda")`.
The object should be a valid `brain_atlas` (check with `is_brain_atlas()`).

Adapt the atlas documentation in `R/cc200.R` to match your atlas.
Take particular care with the reference to the original paper introducing the parcellation.

### Getting tests to pass

Once data is added and references fixed, run the tests:

```{r}
#| label: run-tests
#| eval: false
devtools::test()
```

There will likely be failures.
Try to resolve them by reading the error messages.

Common things to check:

- If you only have a 2D or 3D atlas, comment out test sections that refer to the atlas type you're not including.
- If you have a ggseg-atlas, the tests check for a palette matching `atlas$region`.
  If you haven't created a palette, look at `data-raw/palettes.R` for how to set one up.
  Palettes are stored in the `brain_pal` object as named string vectors.
  Names should match `atlas$region` and values should be hexadecimal colour codes.

Let us know if you struggle.
We would love to improve this tutorial with the issues you encounter.

### Getting package checks to pass

Once all tests pass, run package checks:

```{r}
#| label: run-check
#| eval: false
devtools::check()
```

This attempts to build your package and verify everything works.

Read error messages carefully and try to resolve them.

Common things to check:

- If you haven't added a license, try `usethis::use_mit_license("Your Name Here")`.

If everything passes, push to your remote repository.

## Adding your package to r-universe

Once your package is ready and hosted publicly, submit it to the ggseg r-universe.

### 1. Fork the r-universe repository

Go to [github.com/ggseg/universe](https://github.com/ggseg/universe) and fork the repository.

### 2. Edit packages.json

The `packages.json` file lists all packages in the ggseg r-universe.
Add an entry for your package:

```json
[
  {
    "package": "ggsegYeo2011",
    "url": "https://github.com/ggseg/ggsegYeo2011"
  },
  {
    "package": "yourpackage",
    "url": "https://github.com/yourusername/yourpackage"
  }
]
```

Each entry needs:

- `package`: The exact package name (must match your DESCRIPTION file).
- `url`: The URL to your repository.

For packages not on GitHub, you can also specify a `branch` or use other URL schemes:

```json
{
  "package": "yourpackage",
  "url": "https://gitlab.com/yourusername/yourpackage",
  "branch": "main"
}
```

### 3. Submit a pull request

Commit your changes and open a pull request to the ggseg/universe repository.
Include a brief description of your atlas and a link to any relevant publication.

### 4. Wait for review

We will check that:

- The package installs correctly
- It passes `R CMD check`
- The atlas works with ggseg and/or ggseg3d

Once merged, r-universe automatically builds your package.
It typically appears within an hour at [ggseg.r-universe.dev](https://ggseg.r-universe.dev).

## Installing from r-universe

Users can then install your atlas with:

```{r}
#| label: install-example
#| eval: false
install.packages("yourpackage", repos = "https://ggseg.r-universe.dev")
```

Or use the ggsegExtra helper:

```{r}
#| label: install-helper
#| eval: false
ggseg_atlas_repos("yourpackage")
install_ggseg_atlas("yourpackage")
```

## Updating your package

When you push updates to your repository, r-universe automatically rebuilds the package.
No action needed on your part after the initial setup.

If you move the repository to a different URL, submit a pull request to update `packages.json`.
