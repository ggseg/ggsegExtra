---
title: "Creating atlases from label files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating atlases from label files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

Sometimes you have brain regions defined as individual FreeSurfer label files rather than a complete annotation.
This happens when you extract results from vertex-wise analyses, combine regions from different sources, or work with manually defined ROIs.

`create_atlas_from_labels()` builds an atlas from a collection of `.label` files.

```{r}
#| label: load-libraries
library(ggsegExtra)
library(ggseg)
library(ggseg3d)
library(ggplot2)
```

## Label file format

FreeSurfer label files are text files that list which vertices belong to a region:

```
#!ascii label
5432
1234  -23.5  12.3  45.6  0.0
1235  -23.8  12.1  45.9  0.0
...
```

The first line is a header, the second is the vertex count, and subsequent lines contain vertex index and coordinates.

Label files conventionally include hemisphere in the filename: `lh.motor.label` or `rh.motor.label`.

## Basic usage

Collect your label files and create an atlas:

```{r}
#| label: basic
label_files <- c(
  "lh.motor.label",
  "rh.motor.label",
  "lh.visual.label",
  "rh.visual.label"
)

atlas <- create_atlas_from_labels(label_files)
```

The function detects hemisphere from filename prefixes (`lh.` or `rh.`) and derives region names from the rest of the filename.

## Quick 3D-only atlas

For rapid iteration, skip 2D geometry:

```{r}
#| label: 3d-only
atlas <- create_atlas_from_labels(
  label_files,
  include_geometry = FALSE
)

ggseg3d(atlas = atlas, hemisphere = "left")
```

This returns almost instantly since it just reads vertex indices from the files.

## Custom region names

Override auto-detected names:

```{r}
#| label: custom-names
atlas <- create_atlas_from_labels(
  label_files,
  region_names = c(
    "Primary motor", "Primary motor",
    "Primary visual", "Primary visual"
  )
)
```

Note that left and right hemisphere versions of the same region should have the same region name - the hemisphere column distinguishes them.

## Custom colours

Assign specific colours to each region:

```{r}
#| label: custom-colours
atlas <- create_atlas_from_labels(
  label_files,
  colours = c("#E74C3C", "#E74C3C", "#3498DB", "#3498DB")
)
```

Without explicit colours, the function assigns a rainbow palette.

## Full atlas with 2D geometry

For 2D plots, enable geometry extraction:

```{r}
#| label: full-atlas
output_dir <- withr::local_tempdir()

atlas <- create_atlas_from_labels(
  label_files,
  include_geometry = TRUE,
  output_dir = output_dir,
  view = c("lateral", "medial"),
  smoothness = 5,
  tolerance = 0
)

plot(atlas)
```

This runs the same screenshot pipeline as `create_cortical_atlas()`.

## Finding label files

FreeSurfer includes label files for Brodmann areas and other anatomical landmarks:

```{r}
#| label: find-labels
label_dir <- file.path(freesurfer::fs_subj_dir(), "fsaverage5/label")

ba_labels <- list.files(
  label_dir,
  pattern = "BA[0-9].*\\.label$",
  full.names = TRUE
)

atlas <- create_atlas_from_labels(ba_labels)
```

## Atlas naming

By default, the atlas name derives from the first label filename.
Override it:

```{r}
#| label: atlas-name
atlas <- create_atlas_from_labels(
  label_files,
  atlas_name = "motor_visual"
)
```

## Combining with other sources

Label-based atlases are useful for combining regions from different sources.
For example, extract significant clusters from a statistical analysis:

```{r}
#| label: combining
cluster_labels <- c(
  "lh.cluster1.label",
  "lh.cluster2.label",
  "rh.cluster1.label"
)

atlas <- create_atlas_from_labels(
  cluster_labels,
  atlas_name = "significant_clusters",
  region_names = c("Frontal", "Parietal", "Frontal"),
  colours = c("#E74C3C", "#3498DB", "#E74C3C")
)
```

## Debugging

**No vertices found**: Check that the label file format is correct.
Open it in a text editor - it should start with `#!ascii label`.

**Wrong hemisphere assignment**: The function looks for `lh.` or `rh.` at the start of the filename.
If your files use different conventions, rename them or set hemisphere manually after creation.

**Regions don't appear in 3D**: The vertices in the label file must match the surface mesh.
Labels created for fsaverage won't work with fsaverage5 without resampling.

**Empty polygons in 2D**: Small regions may not be visible from certain angles.
Try adding more views or check if the region is actually on the visible surface.

## Complete example: Brodmann areas

Here is the full pipeline for creating a Brodmann area atlas:

```{r}
#| label: brodmann-complete
library(ggsegExtra)
library(ggseg3d)
library(ggplot2)

label_dir <- file.path(freesurfer::fs_subj_dir(), "fsaverage5/label")

ba_labels <- list.files(
  label_dir,
  pattern = "^[lr]h\\.BA[0-9]+.*\\.label$",
  full.names = TRUE
)

cat("Found", length(ba_labels), "Brodmann area labels\n")

output_dir <- withr::local_tempdir()

ba_atlas <- create_atlas_from_labels(
  ba_labels,
  atlas_name = "brodmann",
  include_geometry = TRUE,
  output_dir = output_dir,
  view = c("lateral", "medial"),
  smoothness = 3,
  tolerance = 0.5
)

ba_atlas$core <- ba_atlas$core |>
  dplyr::mutate(
    region = gsub("\\.", " ", region),
    region = gsub("_exvivo", "", region)
  )

ggseg3d(atlas = ba_atlas, hemisphere = "left") |>
  pan_camera("left lateral")

plot(ba_atlas, show.legend = FALSE)
```
