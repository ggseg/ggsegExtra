---
title: "Tutorial: Creating an atlas from label files"
format: html
---



Sometimes you have brain regions defined as individual FreeSurfer label files rather than a complete annotation.
This happens when you extract results from vertex-wise analyses, combine regions from different sources, or work with manually defined ROIs.

`create_atlas_from_labels()` builds an atlas from a collection of `.label` files.

## What label files contain

FreeSurfer label files are text files that list which vertices belong to a region:

```
#!ascii label
5432
1234  -23.5  12.3  45.6  0.0
1235  -23.8  12.1  45.9  0.0
...
```

The first line is a header, the second is the vertex count, and subsequent lines contain the vertex index and its coordinates.
Label files conventionally include hemisphere in the filename: `lh.motor.label` or `rh.motor.label`.


``` r
library(ggsegExtra)
library(ggseg.formats)
library(dplyr)
```

## Basic usage

Collect your label files and create an atlas:


``` r
label_dir <- file.path(
  freesurfer::fs_dir(), "subjects", "fsaverage5", "label"
)

ba_labels <- list.files(
  label_dir,
  pattern = "^[lr]h\\.BA[0-9]+.*\\.label$",
  full.names = TRUE
)

length(ba_labels)
#> [1] 18
head(basename(ba_labels))
#> [1] "lh.BA1_exvivo.label"  "lh.BA2_exvivo.label"  "lh.BA3a_exvivo.label"
#> [4] "lh.BA3b_exvivo.label" "lh.BA44_exvivo.label" "lh.BA45_exvivo.label"
```


``` r
ba_atlas <- create_atlas_from_labels(
  label_files = ba_labels,
  atlas_name = "brodmann"
)
#> 
#> ── Creating brain atlas "brodmann" ─────────────────────────────────────────────
#> ℹ Input files: '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA1_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA2_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA3a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA3b_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA44_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA45_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA4a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA4p_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA6_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA1_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA2_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA3a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA3b_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA44_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA45_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA4a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA4p_exvivo.label', and '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA6_exvivo.label'
#> ℹ Setting output directory to '/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7'
#> ℹ 1/8 Reading 18 label files
#> ✔ 1/8 Reading 18 label files [157ms]
#> 
#> ℹ 2/8 Taking full brain snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136424222f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613638f30b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131eb0d3d0.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961385dff0e.html screenshot completed
#> ✔ 2/8 Taking full brain snapshots [9.5s]
#> 
#> ℹ 3/8 Taking region snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961343140910.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134c1ced94.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961318ca3170.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137c6eae12.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136b0c0b0b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137a1d8e29.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131e5e3203.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961370825c8a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137dd8fb3c.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961376e5db9a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961344845a78.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613266b931b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961338395a59.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613a417cdb.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613e5b81fc.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132a23ee15.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132adce901.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613433aee23.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136e880032.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133669815e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132c5e571c.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133bca6667.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961336b51baf.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132440e930.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961348d5308d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134d2532c5.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961358593184.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961311268942.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133fcdb09d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961326495525.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132a4ac8b5.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96135ebe15fc.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136f0c1e68.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961342d78f1a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613be06c88.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613421cea46.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613982abf8.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613518a54cf.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137a34804a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96135e6ca1bf.html screenshot completed
#> ✔ 3/8 Taking region snapshots [1m 33.5s]
#> 
#> ℹ 4/8 Isolating regions
#> ✔ 4/8 Isolating regions [6.6s]
#> 
#> ℹ 5/8 Extracting contours
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> ✔ 5/8 Extracting contours [2s]
#> 
#> ℹ 6/8 Smoothing contours (smoothness = 5)
#> ✔ 6/8 Smoothing contours (smoothness = 5) [1.1s]
#> 
#> ℹ 7/8 Reducing vertices (tolerance = 1)
#> ✔ 7/8 Reducing vertices (tolerance = 1) [179ms]
#> 
#> ℹ 8/8 Building atlas data
#> ✔ 8/8 Building atlas data [61ms]
#> 
#> ✔ Temporary files removed
#> ✔ Brain atlas created with 18 regions
#> ℹ Pipeline completed in 1.9 minutes

ba_atlas
#> 
#> ── brodmann ggseg atlas ────────────────────────────────────────────────────────
#> Type: cortical
#> Regions: 9
#> Hemispheres: left, right
#> Views: lateral, medial
#> Palette: ✖
#> Rendering: ✔ ggseg
#> ✔ ggseg3d (vertices)
#> ────────────────────────────────────────────────────────────────────────────────
#> # A tibble: 18 × 3
#>    hemi  region      label         
#>    <chr> <chr>       <chr>         
#>  1 left  BA1_exvivo  lh_BA1_exvivo 
#>  2 left  BA2_exvivo  lh_BA2_exvivo 
#>  3 left  BA3a_exvivo lh_BA3a_exvivo
#>  4 left  BA3b_exvivo lh_BA3b_exvivo
#>  5 left  BA44_exvivo lh_BA44_exvivo
#>  6 left  BA45_exvivo lh_BA45_exvivo
#>  7 left  BA4a_exvivo lh_BA4a_exvivo
#>  8 left  BA4p_exvivo lh_BA4p_exvivo
#>  9 left  BA6_exvivo  lh_BA6_exvivo 
#> 10 right BA1_exvivo  rh_BA1_exvivo 
#> 11 right BA2_exvivo  rh_BA2_exvivo 
#> 12 right BA3a_exvivo rh_BA3a_exvivo
#> 13 right BA3b_exvivo rh_BA3b_exvivo
#> 14 right BA44_exvivo rh_BA44_exvivo
#> 15 right BA45_exvivo rh_BA45_exvivo
#> 16 right BA4a_exvivo rh_BA4a_exvivo
#> 17 right BA4p_exvivo rh_BA4p_exvivo
#> 18 right BA6_exvivo  rh_BA6_exvivo
```

The function detects hemisphere from filename prefixes (`lh.` or `rh.`) and derives region names from the rest of the filename.

## Custom names and colours

Override auto-detected names when the filenames don't produce readable labels:


``` r
atlas <- create_atlas_from_labels(
  label_files = c(
    "lh.motor.label", "rh.motor.label",
    "lh.visual.label", "rh.visual.label"
  ),
  region_names = c(
    "primary motor", "primary motor",
    "primary visual", "primary visual"
  ),
  colours = c("#E74C3C", "#E74C3C", "#3498DB", "#3498DB")
)
```

Left and right hemisphere versions of the same region should share the same region name --- the hemisphere column distinguishes them.

## Full pipeline with 2D geometry

For 2D plots, enable the full pipeline:


``` r
ba_atlas <- create_atlas_from_labels(
  label_files = ba_labels,
  atlas_name = "custom"
)
#> 
#> ── Creating brain atlas "custom" ───────────────────────────────────────────────
#> ℹ Input files: '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA1_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA2_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA3a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA3b_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA44_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA45_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA4a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA4p_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.BA6_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA1_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA2_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA3a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA3b_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA44_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA45_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA4a_exvivo.label', '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA4p_exvivo.label', and '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.BA6_exvivo.label'
#> ℹ Setting output directory to '/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7'
#> ℹ 1/8 Reading 18 label files
#> ✔ 1/8 Reading 18 label files [53ms]
#> 
#> ℹ 2/8 Taking full brain snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96135fc9ff0d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132699ef1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961321387871.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96135447a524.html screenshot completed
#> ✔ 2/8 Taking full brain snapshots [9.2s]
#> 
#> ℹ 3/8 Taking region snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136a0aa21f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613409a740e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133be5dba9.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132e4f0f6e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134df7d5fc.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961337b5033c.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136f9f802b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131ad22891.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961359c63348.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961355339de5.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613400093d9.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961311db8a34.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961356ce377e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133f73d94b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961358553bab.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131452689d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961313325e03.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961344bf9b9f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961331988a23.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136fae0c14.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961378fe92bf.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613407bbf7b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961372e8550.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133ed1760f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961340bcdbff.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131b50d61e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613684830bb.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613109ccd9.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132bf8c1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613211cb061.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961331690693.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134be518d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131222724e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134fe9efa8.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131c79ab06.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133a0c3a8d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133447bf3b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613b10dc79.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131b6d98c1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136bba22a5.html screenshot completed
#> ✔ 3/8 Taking region snapshots [1m 34.2s]
#> 
#> ℹ 4/8 Isolating regions
#> ✔ 4/8 Isolating regions [6.5s]
#> 
#> ℹ 5/8 Extracting contours
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> ✔ 5/8 Extracting contours [2s]
#> 
#> ℹ 6/8 Smoothing contours (smoothness = 5)
#> ✔ 6/8 Smoothing contours (smoothness = 5) [1.1s]
#> 
#> ℹ 7/8 Reducing vertices (tolerance = 1)
#> ✔ 7/8 Reducing vertices (tolerance = 1) [184ms]
#> 
#> ℹ 8/8 Building atlas data
#> ✔ 8/8 Building atlas data [51ms]
#> 
#> ✔ Temporary files removed
#> ✔ Brain atlas created with 18 regions
#> ℹ Pipeline completed in 1.9 minutes

ba_atlas
#> 
#> ── custom ggseg atlas ──────────────────────────────────────────────────────────
#> Type: cortical
#> Regions: 9
#> Hemispheres: left, right
#> Views: lateral, medial
#> Palette: ✖
#> Rendering: ✔ ggseg
#> ✔ ggseg3d (vertices)
#> ────────────────────────────────────────────────────────────────────────────────
#> # A tibble: 18 × 3
#>    hemi  region      label         
#>    <chr> <chr>       <chr>         
#>  1 left  BA1_exvivo  lh_BA1_exvivo 
#>  2 left  BA2_exvivo  lh_BA2_exvivo 
#>  3 left  BA3a_exvivo lh_BA3a_exvivo
#>  4 left  BA3b_exvivo lh_BA3b_exvivo
#>  5 left  BA44_exvivo lh_BA44_exvivo
#>  6 left  BA45_exvivo lh_BA45_exvivo
#>  7 left  BA4a_exvivo lh_BA4a_exvivo
#>  8 left  BA4p_exvivo lh_BA4p_exvivo
#>  9 left  BA6_exvivo  lh_BA6_exvivo 
#> 10 right BA1_exvivo  rh_BA1_exvivo 
#> 11 right BA2_exvivo  rh_BA2_exvivo 
#> 12 right BA3a_exvivo rh_BA3a_exvivo
#> 13 right BA3b_exvivo rh_BA3b_exvivo
#> 14 right BA44_exvivo rh_BA44_exvivo
#> 15 right BA45_exvivo rh_BA45_exvivo
#> 16 right BA4a_exvivo rh_BA4a_exvivo
#> 17 right BA4p_exvivo rh_BA4p_exvivo
#> 18 right BA6_exvivo  rh_BA6_exvivo
```

This runs the same screenshot pipeline as `create_cortical_atlas()` --- it takes screenshots of each region from multiple angles, extracts contours, and converts them to sf polygons.

## Post-processing

Clean up region names:


``` r
ba_atlas <- ba_atlas |>
  atlas_region_contextual("cortex", match_on = "label") |>
  atlas_region_contextual("unknown", match_on = "label") |>
  atlas_view_gather()

core_clean <- ba_atlas$core |>
  mutate(
    region = gsub("\\.", " ", region),
    region = gsub("_exvivo", "", region)
  )

ba_atlas <- brain_atlas(
  atlas = ba_atlas$atlas,
  type = ba_atlas$type,
  palette = ba_atlas$palette,
  core = core_clean,
  data = ba_atlas$data
)
```

## Finding label files

FreeSurfer ships with several sets of label files.
Brodmann areas are the most common:


``` r
label_dir <- file.path(
  freesurfer::fs_dir(), "subjects", "fsaverage5", "label"
)

ba_files <- list.files(label_dir, "^[lr]h\\.BA.*\\.label$", full.names = TRUE)
length(ba_files)
#> [1] 18
```

Other useful labels include V1/V2, MT, and entorhinal cortex.
Any label file that maps to the same surface (typically fsaverage5) can be combined into one atlas.

## Combining regions from different sources

Label-based atlases are useful when you want to mix regions from different analyses or atlases.
Each label file is independent, so you can combine freely:


``` r
my_labels <- c(
  "lh.BA1_exvivo.label",
  "lh.BA2_exvivo.label",
  "lh.V1.label",
  "rh.BA1_exvivo.label",
  "rh.BA2_exvivo.label",
  "rh.V1.label"
)

atlas <- create_atlas_from_labels(
  label_files = file.path(label_dir, my_labels),
  atlas_name = "somatosensory_visual",
  region_names = c(
    "BA1", "BA2", "V1",
    "BA1", "BA2", "V1"
  ),
  colours = c(
    "#E74C3C", "#C0392B", "#3498DB",
    "#E74C3C", "#C0392B", "#3498DB"
  )
)
```

The only constraint is that all label files must reference the same surface mesh.
Labels created for fsaverage won't match fsaverage5 vertices without resampling.
