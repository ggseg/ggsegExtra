---
title: "Tutorial: Creating an atlas from neuromaps"
format: html
---

```{r}
#| label: setup
#| include: false
can_run <- set_tutorial_options()
```

The [neuromaps](https://github.com/netneurolab/neuromaps) project provides standardized brain maps from published studies --- PET receptor densities, gene expression gradients, cortical thickness, and hundreds of other measures.
These brain maps are continuous: each vertex on the cortical surface has a floating-point value rather than a parcel label.

`create_cortical_from_neuromaps()` turns any neuromaps annotation into a ggseg atlas by discretizing the continuous values into quantile bins, each becoming a plottable region.
This tutorial walks through the full workflow, from fetching an annotation to fine-tuning the binning.

## What you need

- The [neuromapr](https://github.com/ggsegverse/neuromapr) package (for fetching neuromaps annotations)
- FreeSurfer installed with the `fsaverage5` subject (for volume annotations and the full 2D pipeline)
- ImageMagick and Chrome/Chromium (for 2D geometry extraction)

For a 3D-only atlas (`steps = 1`), FreeSurfer is only needed if the annotation is a volume file.

```{r}
#| label: load-libraries
#| eval: !expr can_run
library(ggseg.extra)
library(ggseg.formats)
library(dplyr)
library(ggplot2)
```

## Fetching a neuromaps annotation

The `source` and `desc` arguments identify the brain map in the neuromaps registry.
For this tutorial we use the first principal component of gene expression from the Allen Human Brain Atlas, provided by [abagen](https://abagen.readthedocs.io/).

```{r}
#| label: 3d-only
#| eval: !expr can_run
atlas_auto <- create_cortical_from_neuromaps(
  source = "abagen",
  desc = "genepc1",
  atlas_name = "abagen_genepc1",
  steps = 1
)

atlas_auto
```

`steps = 1` reads the annotation and builds a 3D-only atlas --- no screenshots, no 2D geometry.
This finishes in seconds and gives you a quick sanity check before committing to the full pipeline.

The regions listed are the quantile bins the pipeline created automatically.
Each bin corresponds to a range of gene expression values and covers roughly the same number of vertices.

## How binning works

Neuromaps annotations are continuous --- every vertex has a value like 0.42 or −1.73 rather than a label like "precuneus."
To turn these into plottable atlas regions, the pipeline discretizes the values into bins.
Each bin becomes a region colored along a spectral gradient from low to high values.

### Auto-detection: parcellation vs. continuous

When the pipeline reads the annotation data, it first checks whether the vertex values are integers or floating-point:

- **Integer values** → treated as a parcellation. Each unique ID becomes a region. Value 0 is the medial wall. No binning.
- **Floating-point values** → treated as a continuous brain map. NaN vertices are the medial wall. Remaining values are binned.

This detection is automatic.
If you have a parcellation map from neuromaps (like Schaefer parcels), the pipeline will handle it as discrete regions without binning.

### The `n_bins` parameter

`n_bins` controls how many quantile bins continuous data is split into.

**NULL (the default)** uses Sturges' rule to auto-detect the bin count.
The formula is `1 + log2(n)` where *n* is the number of valid (non-NaN) vertices, clamped to the range 5--20.
For fsaverage5 with 10,242 vertices per hemisphere, this gives `1 + log2(10242) ≈ 14` bins.

```{r}
#| label: auto-bins
#| eval: !expr can_run
nrow(atlas_auto$core)
atlas_auto$core |> filter(region != "unknown") |> distinct(region)
```

**An explicit integer** overrides auto-detection.
Use fewer bins for a cleaner, more schematic look; more bins for finer spatial resolution.

```{r}
#| label: explicit-bins
#| eval: !expr can_run
atlas_5 <- create_cortical_from_neuromaps(
  source = "abagen",
  desc = "genepc1",
  n_bins = 5,
  atlas_name = "abagen_5bin",
  steps = 1
)

atlas_5$core |> filter(region != "unknown") |> distinct(region)
```

```{r}
#| label: many-bins
#| eval: !expr can_run
atlas_20 <- create_cortical_from_neuromaps(
  source = "abagen",
  desc = "genepc1",
  n_bins = 20,
  atlas_name = "abagen_20bin",
  steps = 1
)

atlas_20$core |> filter(region != "unknown") |> distinct(region)
```

### Quantile-based breaks

Bins are created using quantile breaks, not equal-width intervals.
This means each bin contains approximately the same number of vertices.

Equal-width bins would leave most vertices in a few central bins when the distribution is skewed, which is common for brain maps.
Quantile binning ensures every bin contributes visible surface area to the atlas, making the resulting plot informative regardless of the data distribution.

### Color palette

Bins are colored using the HCL Spectral palette.
Bin 1 (lowest values) gets the cool end of the spectrum, and the last bin (highest values) gets the warm end.
The medial wall is always grey (`#BEBEBE`) and labeled "unknown."

```{r}
#| label: show-palette
#| eval: !expr can_run
atlas_auto$palette
```

## Visualizing the effect of bin count

Comparing the 3D rendering across different bin counts makes it easy to choose the right level of detail:

```{r}
#| label: compare-3d-5
#| eval: !expr can_run
#| fig-cap: "3D brain rendering with 5 quantile bins."
#| fig-alt: "3D rendering of the left hemisphere coloured by 5 quantile bins of gene expression values, showing broad spatial patterns."
ggseg3d::ggseg3d(atlas = atlas_5, hemisphere = "left")
```

```{r}
#| label: compare-3d-auto
#| eval: !expr can_run
#| fig-cap: "3D brain rendering with auto-detected bins (Sturges' rule)."
#| fig-alt: "3D rendering of the left hemisphere coloured by approximately 14 auto-detected quantile bins, showing finer spatial detail than the 5-bin version."
ggseg3d::ggseg3d(atlas = atlas_auto, hemisphere = "left")
```

```{r}
#| label: compare-3d-20
#| eval: !expr can_run
#| fig-cap: "3D brain rendering with 20 quantile bins."
#| fig-alt: "3D rendering of the left hemisphere coloured by 20 quantile bins, showing fine-grained spatial gradients."
ggseg3d::ggseg3d(atlas = atlas_20, hemisphere = "left")
```

## Full 2D atlas pipeline

Once you're happy with the binning, run the full pipeline to generate 2D polygon geometry for plotting with ggseg.
We use 7 bins here for a balance between clarity and resolution:

```{r}
#| label: full-pipeline
#| eval: !expr can_run
output_dir <- file.path(tempdir(), "neuromaps_tutorial")

atlas_full <- create_cortical_from_neuromaps(
  source = "abagen",
  desc = "genepc1",
  n_bins = 7,
  atlas_name = "abagen_genepc1",
  output_dir = output_dir,
  tolerance = 1,
  smoothness = 5,
  skip_existing = TRUE,
  cleanup = FALSE,
  verbose = TRUE
)

atlas_full
```

The pipeline steps are:

| Step | Description |
|------|-------------|
| 1 | Read neuromaps annotation and bin values |
| 2 | Take full brain screenshots |
| 3 | Take per-region screenshots |
| 4 | Isolate region masks |
| 5 | Extract contours |
| 6 | Smooth contours |
| 7 | Reduce vertices |
| 8 | Build final atlas geometry |

Use `skip_existing = TRUE` and `cleanup = FALSE` during development so you can re-run later steps without repeating the slow screenshot capture.

## Post-processing

The "unknown" region (medial wall) renders as a filled region by default.
Convert it to a background outline with `atlas_region_contextual()`:

```{r}
#| label: post-process
#| eval: !expr can_run
atlas_clean <- atlas_full |>
  atlas_region_contextual("unknown", match_on = "label")
```

## Rendering the final atlas

```{r}
#| label: plot-2d
#| eval: !expr can_run
#| fig-cap: "2D gene expression atlas plotted with ggseg."
#| fig-alt: "2D brain atlas plot showing gene expression quantile bins across lateral, medial, inferior, and superior views without legend."
#| fig-width: 10
#| fig-height: 6
plot(atlas_clean, show.legend = FALSE) +
  theme_void()
```

```{r}
#| label: plot-3d
#| eval: !expr can_run
#| fig-cap: "3D rendering of the final gene expression atlas."
#| fig-alt: "3D rendering of the left hemisphere showing the final gene expression atlas with 7 quantile bins coloured along a spectral gradient."
ggseg3d::ggseg3d(atlas = atlas_clean, hemisphere = "left")
```

## Working with parcellation maps

Not all neuromaps annotations are continuous.
Some contain integer vertex labels where each value maps to a brain region.
The pipeline detects this automatically and skips binning entirely.

For parcellations, you can provide a `label_table` to map the numeric IDs to human-readable region names and custom colors:

```{r}
#| label: label-table
#| eval: false
labels <- data.frame(
  id = c(1, 2, 3),
  region = c("visual", "somatomotor", "dorsal_attention"),
  colour = c("#781286", "#4682B4", "#00760E")
)

atlas <- create_cortical_from_neuromaps(
  source = "schaefer",
  desc = "400Parcels7Networks",
  label_table = labels,
  steps = 1
)
```

Parcels not listed in `label_table` are auto-named as `parcel_1`, `parcel_2`, etc. and assigned colors from the Set2 palette.

## Volume annotations

Some neuromaps annotations are volumetric NIfTI files in MNI152 space rather than surface GIFTI files.
The pipeline detects this from the file extension (`.nii` or `.nii.gz`) and projects the volume onto the fsaverage5 surface using FreeSurfer's `mri_vol2surf`.

```{r}
#| label: volume
#| eval: false
atlas_vol <- create_cortical_from_neuromaps(
  source = "pet",
  desc = "5HT1a",
  atlas_name = "serotonin_5ht1a",
  n_bins = 10,
  steps = 1
)
```

The volume-to-surface projection samples across cortical depth (0% to 100% in 10% steps) and takes the maximum value at each vertex, giving robust coverage even for thin cortical signals.
FreeSurfer is always required for volume annotations.

## Reading annotation files directly

If you already have GIFTI files on disk --- from neuromaps, Connectome Workbench, or another source --- you can bypass the fetching step and read them directly with `read_neuromaps_annotation()`:

```{r}
#| label: read-direct
#| eval: !expr can_run
files <- neuromapr::fetch_neuromaps_annotation(
  source = "abagen",
  desc = "genepc1",
  space = "fsaverage",
  density = "10k",
  verbose = FALSE
)

annot_data <- read_neuromaps_annotation(files, n_bins = 7)
annot_data
```

For volume files in MNI152 space, use `read_neuromaps_volume()` instead.

## Choosing the right number of bins

| n_bins | Use case |
|--------|----------|
| 3--5 | High-level overview, schematic figures, publication thumbnails |
| 7--10 | Balanced detail, good for most visualizations |
| ~14 (auto) | Default; maximum spatial detail from Sturges' rule |
| 15--20 | Dense gradients where fine differences matter |

More bins means more regions, more screenshots, and longer pipeline runtime for the full 2D extraction.
Start with `steps = 1` to preview the binning in 3D, then run the full pipeline once you're satisfied.

## Saving

Once you're happy with the atlas, save it as package data:

```{r}
#| label: save
#| eval: false
usethis::use_data(abagen_genepc1, overwrite = TRUE, compress = "xz")
```

The `compress = "xz"` flag gives the best compression for sf geometry data.
