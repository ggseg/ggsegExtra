---
title: "Tutorial: Creating an atlas from label files"
format: html
---

```{r}
#| label: setup
#| include: false
can_run <- set_tutorial_options()
```

Sometimes you have brain regions defined as individual FreeSurfer label files rather than a complete annotation.
This happens when you extract results from vertex-wise analyses, combine regions from different sources, or work with manually defined ROIs.

`create_atlas_from_labels()` builds an atlas from a collection of `.label` files.

## What label files contain

FreeSurfer label files are text files that list which vertices belong to a region:

```
#!ascii label
5432
1234  -23.5  12.3  45.6  0.0
1235  -23.8  12.1  45.9  0.0
...
```

The first line is a header, the second is the vertex count, and subsequent lines contain the vertex index and its coordinates.
Label files conventionally include hemisphere in the filename: `lh.motor.label` or `rh.motor.label`.

```{r}
#| label: load-libraries
#| eval: !expr can_run
library(ggsegExtra)
library(ggseg.formats)
library(dplyr)
```

## Basic usage

Collect your label files and create an atlas:

```{r}
#| label: find-labels
#| eval: !expr can_run
label_dir <- file.path(
  freesurfer::fs_dir(), "subjects", "fsaverage5", "label"
)

ba_labels <- list.files(
  label_dir,
  pattern = "^[lr]h\\.BA[0-9]+.*\\.label$",
  full.names = TRUE
)

length(ba_labels)
head(basename(ba_labels))
```

```{r}
#| label: basic-atlas
#| eval: !expr can_run
ba_atlas <- create_atlas_from_labels(
  label_files = ba_labels,
  atlas_name = "brodmann"
)

ba_atlas
```

The function detects hemisphere from filename prefixes (`lh.` or `rh.`) and derives region names from the rest of the filename.

## Custom names and colours

Override auto-detected names when the filenames don't produce readable labels:

```{r}
#| label: custom-names
#| eval: false
atlas <- create_atlas_from_labels(
  label_files = c(
    "lh.motor.label", "rh.motor.label",
    "lh.visual.label", "rh.visual.label"
  ),
  region_names = c(
    "primary motor", "primary motor",
    "primary visual", "primary visual"
  ),
  colours = c("#E74C3C", "#E74C3C", "#3498DB", "#3498DB")
)
```

Left and right hemisphere versions of the same region should share the same region name --- the hemisphere column distinguishes them.

## Full pipeline with 2D geometry

For 2D plots, enable the full pipeline:

```{r}
#| label: full-atlas
#| eval: !expr can_run

ba_atlas <- create_atlas_from_labels(
  label_files = ba_labels,
  atlas_name = "custom"
)

ba_atlas
```

This runs the same screenshot pipeline as `create_cortical_atlas()` --- it takes screenshots of each region from multiple angles, extracts contours, and converts them to sf polygons.

## Post-processing

Clean up region names:

```{r}
#| label: post-process
#| eval: !expr can_run
ba_atlas <- ba_atlas |>
  atlas_region_contextual("cortex", match_on = "label") |>
  atlas_region_contextual("unknown", match_on = "label") |>
  atlas_view_gather()

core_clean <- ba_atlas$core |>
  mutate(
    region = gsub("\\.", " ", region),
    region = gsub("_exvivo", "", region)
  )

ba_atlas <- brain_atlas(
  atlas = ba_atlas$atlas,
  type = ba_atlas$type,
  palette = ba_atlas$palette,
  core = core_clean,
  data = ba_atlas$data
)
```

## Finding label files

FreeSurfer ships with several sets of label files.
Brodmann areas are the most common:

```{r}
#| label: brodmann-labels
#| eval: !expr can_run
label_dir <- file.path(
  freesurfer::fs_dir(), "subjects", "fsaverage5", "label"
)

ba_files <- list.files(label_dir, "^[lr]h\\.BA.*\\.label$", full.names = TRUE)
length(ba_files)
```

Other useful labels include V1/V2, MT, and entorhinal cortex.
Any label file that maps to the same surface (typically fsaverage5) can be combined into one atlas.

## Combining regions from different sources

Label-based atlases are useful when you want to mix regions from different analyses or atlases.
Each label file is independent, so you can combine freely:

```{r}
#| label: combine
#| eval: false
my_labels <- c(
  "lh.BA1_exvivo.label",
  "lh.BA2_exvivo.label",
  "lh.V1.label",
  "rh.BA1_exvivo.label",
  "rh.BA2_exvivo.label",
  "rh.V1.label"
)

atlas <- create_atlas_from_labels(
  label_files = file.path(label_dir, my_labels),
  atlas_name = "somatosensory_visual",
  region_names = c(
    "BA1", "BA2", "V1",
    "BA1", "BA2", "V1"
  ),
  colours = c(
    "#E74C3C", "#C0392B", "#3498DB",
    "#E74C3C", "#C0392B", "#3498DB"
  )
)
```

The only constraint is that all label files must reference the same surface mesh.
Labels created for fsaverage won't match fsaverage5 vertices without resampling.
