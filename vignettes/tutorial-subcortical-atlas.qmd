---
title: "Tutorial: Creating a subcortical atlas"
format: html
---



Subcortical atlases represent the structures beneath the cortical surface: thalamus, hippocampus, amygdala, caudate, putamen, and others.
They come from volumetric segmentations like FreeSurfer's `aseg.mgz`, where each voxel is assigned a label.

The pipeline tessellates labelled voxel regions into 3D meshes and (optionally) creates 2D projection views that collapse a slab of the volume onto a single plane.

This tutorial recreates the aseg atlas --- the same pipeline behind `data-raw/make_aseg_atlas.R` in ggseg.formats.

## What you need

- FreeSurfer installed with the `fsaverage5` subject
- ImageMagick for 2D geometry extraction
- Chrome/Chromium for 3D screenshots


``` r
library(ggseg.extra)
library(ggseg.formats)
library(dplyr)
```


``` r
fs_dir <- freesurfer::fs_dir()
subjects_dir <- file.path(fs_dir, "subjects")

aseg_volume <- file.path(subjects_dir, "fsaverage5", "mri", "aseg.mgz")
color_lut <- file.path(fs_dir, "ASegStatsLUT.txt")

if (!file.exists(color_lut)) {
  color_lut <- file.path(fs_dir, "FreeSurferColorLUT.txt")
}
```

## Creating the atlas

`create_subcortical_from_volume()` takes a segmentation volume and a colour lookup table.
The pipeline tessellates each labelled region into a 3D mesh, then creates 2D projection views:


``` r
aseg_raw <- create_subcortical_from_volume(
  input_volume = aseg_volume,
  input_lut = color_lut,
  atlas_name = "aseg"
)
#> Warning: Atlas has 11943 vertices (threshold:
#> 10000)
#> â„¹ Large atlases may be slow to plot and
#>   increase package size
#> â„¹ Re-run with higher `tolerance` to
#>   reduce vertices

aseg_raw
#> 
#> â”€â”€ aseg ggseg atlas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#> Type: subcortical
#> Regions: 27
#> Hemispheres: left, NA, right
#> Views: axial_1, axial_2, axial_3,
#> axial_4, axial_5, axial_6, axial_7,
#> coronal_1, coronal_2, coronal_3,
#> coronal_4, coronal_5, sagittal
#> Palette: âœ”
#> Rendering: âœ” ggseg
#> âœ” ggseg3d (meshes)
#> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#> # A tibble: 43 Ã— 3
#>    hemi  region                  label    
#>    <chr> <chr>                   <chr>    
#>  1 left  cerebral white matter   Left-Cerâ€¦
#>  2 left  cerebral cortex         Left-Cerâ€¦
#>  3 left  lateral ventricle       Left-Latâ€¦
#>  4 left  inf lat vent            Left-Infâ€¦
#>  5 left  cerebellum white matter Left-Cerâ€¦
#>  6 left  cerebellum cortex       Left-Cerâ€¦
#>  7 left  thalamus                Left-Thaâ€¦
#>  8 left  caudate                 Left-Cauâ€¦
#>  9 left  putamen                 Left-Putâ€¦
#> 10 left  pallidum                Left-Palâ€¦
#> 11 <NA>  3rd ventricle           3rd-Ventâ€¦
#> 12 <NA>  4th ventricle           4th-Ventâ€¦
#> 13 <NA>  brain stem              Brain-Stâ€¦
#> 14 left  hippocampus             Left-Hipâ€¦
#> 15 left  amygdala                Left-Amyâ€¦
#> 16 <NA>  csf                     CSF      
#> 17 left  accumbens area          Left-Accâ€¦
#> 18 left  ventraldc               Left-Venâ€¦
#> 19 left  vessel                  Left-vesâ€¦
#> 20 left  choroid plexus          Left-choâ€¦
#> 21 right cerebral white matter   Right-Ceâ€¦
#> 22 right cerebral cortex         Right-Ceâ€¦
#> 23 right lateral ventricle       Right-Laâ€¦
#> 24 right inf lat vent            Right-Inâ€¦
#> 25 right cerebellum white matter Right-Ceâ€¦
#> 26 right cerebellum cortex       Right-Ceâ€¦
#> 27 right thalamus                Right-Thâ€¦
#> 28 right caudate                 Right-Caâ€¦
#> 29 right putamen                 Right-Puâ€¦
#> 30 right pallidum                Right-Paâ€¦
#> 31 right hippocampus             Right-Hiâ€¦
#> 32 right amygdala                Right-Amâ€¦
#> 33 right accumbens area          Right-Acâ€¦
#> 34 right ventraldc               Right-Veâ€¦
#> 35 right vessel                  Right-veâ€¦
#> 36 right choroid plexus          Right-châ€¦
#> 37 <NA>  wm hypointensities      WM-hypoiâ€¦
#> 38 <NA>  optic chiasm            Optic-Châ€¦
#> 39 <NA>  cc posterior            CC_Posteâ€¦
#> 40 <NA>  cc mid posterior        CC_Mid_Pâ€¦
#> 41 <NA>  cc central              CC_Centrâ€¦
#> 42 <NA>  cc mid anterior         CC_Mid_Aâ€¦
#> 43 <NA>  cc anterior             CC_Anterâ€¦
```

The default pipeline creates six projection views focused on the subcortical range:
axial inferior, axial superior, coronal posterior, coronal anterior, sagittal left, and sagittal right.
Each view collapses a slab of the volume onto a single plane, giving you spatial context without the complexity of individual slices.

## Removing unwanted regions

The aseg segmentation contains everything --- cortex, white matter, ventricles, CSF.
For a subcortical atlas, most of these are noise.
Remove them:


``` r
aseg_raw <- aseg_raw |>
  atlas_region_remove("White-Matter", match_on = "label") |>
  atlas_region_remove("WM-hypointensities", match_on = "label") |>
  atlas_region_remove("-Ventricle", match_on = "label") |>
  atlas_region_remove("-Vent$", match_on = "label") |>
  atlas_region_remove("CSF", match_on = "label") |>
  atlas_region_remove("Cerebral-Cortex", match_on = "label")
```

Patterns are regular expressions, so `-Vent$` matches "3rd-Vent" and "4th-Vent" without catching "Ventral-DC."

## Setting context regions

The cortex works well as a background outline --- it shows where subcortical structures sit relative to the brain surface without competing for colour:


``` r
aseg_raw <- aseg_raw |>
  atlas_region_contextual("Cortex", match_on = "label")
```

## Selecting views

Not all projection views are equally useful.
Keep the ones that show your structures best:


``` r
aseg_raw <- aseg_raw |>
  atlas_view_keep("axial_3|axial_5|coronal_2|coronal_3|coronal_4|sagittal")
```

## Cleaning up the layout

Gather views into a compact arrangement:


``` r
aseg_raw <- aseg_raw |>
  atlas_view_gather()
```

## Adding metadata

The raw labels are technical identifiers like "Left-Thalamus-Proper."
Join human-readable names and structural groupings:


``` r
normalize_region <- function(x) {
  ifelse(
    is.na(x),
    NA_character_,
    x |>
      tolower() |>
      gsub("-", " ", x = _) |>
      gsub("_", " ", x = _) |>
      gsub("left |right ", "", x = _) |>
      trimws()
  )
}

aseg_metadata <- data.frame(
  region = c(
    "Thalamus-Proper", "Caudate", "Putamen", "Pallidum",
    "Hippocampus", "Amygdala", "Accumbens-area", "VentralDC",
    "Brain-Stem"
  ),
  label_pretty = c(
    "thalamus", "caudate", "putamen", "pallidum",
    "hippocampus", "amygdala", "nucleus accumbens", "ventral DC",
    "brain stem"
  ),
  structure = c(
    "diencephalon", "basal ganglia", "basal ganglia", "basal ganglia",
    "limbic", "limbic", "basal ganglia", "diencephalon",
    "brainstem"
  )
)

core_with_meta <- aseg_raw$core |>
  mutate(region_key = normalize_region(region)) |>
  left_join(
    aseg_metadata |>
      mutate(region_key = normalize_region(region)) |>
      select(region_key, label_pretty, structure),
    by = "region_key"
  ) |>
  mutate(region = coalesce(label_pretty, region)) |>
  select(hemi, region, label, structure)
```

## Rebuilding and saving

Construct the final atlas from modified components:


``` r
aseg <- ggseg_atlas(
  atlas = aseg_raw$atlas,
  type = aseg_raw$type,
  palette = aseg_raw$palette,
  core = core_with_meta,
  data = aseg_raw$data
)

aseg
#> 
#> â”€â”€ aseg ggseg atlas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#> Type: subcortical
#> Regions: 17
#> Hemispheres: left, NA, right
#> Views: axial_3, axial_5, coronal_2,
#> coronal_3, coronal_4, sagittal
#> Palette: âœ”
#> Rendering: âœ” ggseg
#> âœ” ggseg3d (meshes)
#> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#> # A tibble: 27 Ã— 4
#>    hemi  region            label structure
#>    <chr> <chr>             <chr> <chr>    
#>  1 left  thalamus          Leftâ€¦ <NA>     
#>  2 left  caudate           Leftâ€¦ basal gaâ€¦
#>  3 left  putamen           Leftâ€¦ basal gaâ€¦
#>  4 left  pallidum          Leftâ€¦ basal gaâ€¦
#>  5 <NA>  brain stem        Braiâ€¦ brainstem
#>  6 left  hippocampus       Leftâ€¦ limbic   
#>  7 left  amygdala          Leftâ€¦ limbic   
#>  8 left  nucleus accumbens Leftâ€¦ basal gaâ€¦
#>  9 left  ventral DC        Leftâ€¦ diencephâ€¦
#> 10 left  vessel            Leftâ€¦ <NA>     
#> 11 left  choroid plexus    Leftâ€¦ <NA>     
#> 12 right thalamus          Righâ€¦ <NA>     
#> 13 right caudate           Righâ€¦ basal gaâ€¦
#> 14 right putamen           Righâ€¦ basal gaâ€¦
#> 15 right pallidum          Righâ€¦ basal gaâ€¦
#> 16 right hippocampus       Righâ€¦ limbic   
#> 17 right amygdala          Righâ€¦ limbic   
#> 18 right nucleus accumbens Righâ€¦ basal gaâ€¦
#> 19 right ventral DC        Righâ€¦ diencephâ€¦
#> 20 right vessel            Righâ€¦ <NA>     
#> 21 right choroid plexus    Righâ€¦ <NA>     
#> 22 <NA>  optic chiasm      Optiâ€¦ <NA>     
#> 23 <NA>  cc posterior      CC_Pâ€¦ <NA>     
#> 24 <NA>  cc mid posterior  CC_Mâ€¦ <NA>     
#> 25 <NA>  cc central        CC_Câ€¦ <NA>     
#> 26 <NA>  cc mid anterior   CC_Mâ€¦ <NA>     
#> 27 <NA>  cc anterior       CC_Aâ€¦ <NA>
```


``` r
brain_labels(aseg)
#> Warning: `brain_labels()` was deprecated in
#> ggseg.formats 0.1.0.
#> â„¹ Please use `atlas_labels()` instead.
#> â„¹ The deprecated feature was likely used
#>   in the ggseg.extra package.
#>   Please report the issue at
#>   <]8;;https://github.com/ggsegverse/ggseg.extra/issueshttps://github.com/ggsegverse/ggseg.extra/issues]8;;>.
#> This warning is displayed once per
#> session.
#> Call ]8;;x-r-run:lifecycle::last_lifecycle_warnings()lifecycle::last_lifecycle_warnings()]8;;
#> to see where this warning was generated.
#>  [1] "Brain-Stem"          
#>  [2] "CC_Anterior"         
#>  [3] "CC_Central"          
#>  [4] "CC_Mid_Anterior"     
#>  [5] "CC_Mid_Posterior"    
#>  [6] "CC_Posterior"        
#>  [7] "Left-Accumbens-area" 
#>  [8] "Left-Amygdala"       
#>  [9] "Left-Caudate"        
#> [10] "Left-choroid-plexus" 
#> [11] "Left-Hippocampus"    
#> [12] "Left-Pallidum"       
#> [13] "Left-Putamen"        
#> [14] "Left-Thalamus"       
#> [15] "Left-VentralDC"      
#> [16] "Left-vessel"         
#> [17] "Optic-Chiasm"        
#> [18] "Right-Accumbens-area"
#> [19] "Right-Amygdala"      
#> [20] "Right-Caudate"       
#> [21] "Right-choroid-plexus"
#> [22] "Right-Hippocampus"   
#> [23] "Right-Pallidum"      
#> [24] "Right-Putamen"       
#> [25] "Right-Thalamus"      
#> [26] "Right-VentralDC"     
#> [27] "Right-vessel"

table(aseg$core$structure)
#> 
#> basal ganglia     brainstem  diencephalon 
#>             8             1             2 
#>        limbic 
#>             4
```


``` r
plot(aseg)
```

<div class="figure">
<img src="figures/tutorial-subcortical-atlas-plot-1.png" alt="2D brain atlas plot showing subcortical structures including thalamus, caudate, putamen, hippocampus, and amygdala across axial, coronal, and sagittal projection views." width="960" />
<p class="caption">Subcortical aseg atlas plotted with ggseg.</p>
</div>
