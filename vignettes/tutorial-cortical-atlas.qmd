---
title: "Tutorial: Creating a cortical atlas"
format: html
---



Cortical parcellations divide the brain surface into labelled regions.
They come from FreeSurfer annotation files, where each vertex on the cortical mesh is assigned to a region like "superior frontal gyrus" or "precuneus."

This tutorial walks through the full pipeline for turning an annotation into a `brain_atlas` you can plot with ggseg and ggseg3d.
We'll use the Yeo 7-network parcellation as a working example --- it has only 7 regions per hemisphere, so the pipeline runs quickly.

## What you need

- FreeSurfer installed with the `fsaverage5` subject
- ImageMagick for 2D geometry extraction
- Chrome/Chromium for 3D screenshots


``` r
library(ggsegExtra)
library(ggseg.formats)
library(dplyr)
```

## Locating annotation files

FreeSurfer stores annotation files alongside the subject's surface data.
You need the full paths to the `lh.` and `rh.` annotation files:


``` r
fs_dir <- freesurfer::fs_dir()
subjects_dir <- file.path(fs_dir, "subjects")

annot_files <- file.path(
  subjects_dir, "fsaverage5", "label",
  c("lh.Yeo2011_7Networks_N1000.annot",
    "rh.Yeo2011_7Networks_N1000.annot")
)

all(file.exists(annot_files))
#> [1] TRUE
```

## Step 1: 3D-only atlas for fast iteration

Before committing to the full 2D extraction pipeline, verify your annotation looks right with a 3D-only atlas.
This reads the annotation file, extracts vertex assignments, and returns in seconds:


``` r
yeo7_3d <- create_cortical_atlas(
  input_annot = annot_files,
  atlas_name = "yeo7",
  steps = 1
)
#> 
#> ── Creating brain atlas "yeo7" ─────────────────────────────────────────────────
#> ℹ Input files: '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.Yeo2011_7Networks_N1000.annot' and '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.Yeo2011_7Networks_N1000.annot'
#> ℹ Setting output directory to '/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7'
#> ℹ 1/8 Reading annotation files
#> Warning: ! Reading from version `-2`, there may be issues.
#> colortable with 8 entries read (from "MyColorLUT"
#> ℹ 1/8 Reading annotation files
#> Warning: ! Reading from version `-2`, there may be issues.
#> colortable with 8 entries read (from "MyColorLUT"
#> ℹ 1/8 Reading annotation files✔ 1/8 Reading annotation files [69ms]
#> 
#> ✔ 3D atlas created with 16 regions
#> ℹ Pipeline completed in 0 minutes

yeo7_3d
#> 
#> ── yeo7 ggseg atlas ────────────────────────────────────────────────────────────
#> Type: cortical
#> Regions: 8
#> Hemispheres: left, right
#> Palette: ✔
#> Rendering: ✖ ggseg
#> ✔ ggseg3d (vertices)
#> ────────────────────────────────────────────────────────────────────────────────
#> # A tibble: 16 × 3
#>    hemi  region      label         
#>    <chr> <chr>       <chr>         
#>  1 left  7Networks_1 lh_7Networks_1
#>  2 left  7Networks_2 lh_7Networks_2
#>  3 left  7Networks_3 lh_7Networks_3
#>  4 left  7Networks_4 lh_7Networks_4
#>  5 left  7Networks_5 lh_7Networks_5
#>  6 left  7Networks_6 lh_7Networks_6
#>  7 left  7Networks_7 lh_7Networks_7
#>  8 left  unknown     lh_unknown    
#>  9 right 7Networks_1 rh_7Networks_1
#> 10 right 7Networks_2 rh_7Networks_2
#> 11 right 7Networks_3 rh_7Networks_3
#> 12 right 7Networks_4 rh_7Networks_4
#> 13 right 7Networks_5 rh_7Networks_5
#> 14 right 7Networks_6 rh_7Networks_6
#> 15 right 7Networks_7 rh_7Networks_7
#> 16 right unknown     rh_unknown
```

`steps = 1` tells the pipeline to stop after reading annotation data.
The result works with ggseg3d but has no 2D geometry yet.

## Step 2: Full pipeline with 2D geometry

The full pipeline takes screenshots of each region from multiple view angles, extracts contours, and converts them to sf polygons.
This is the slow part --- it needs FreeSurfer, Chrome, and ImageMagick:


``` r
output_dir <- file.path(tempdir(), "yeo7_tutorial")

yeo7_raw <- create_cortical_atlas(
  input_annot = annot_files,
  atlas_name = "yeo7",
  output_dir = output_dir,
  tolerance = 1,
  smoothness = 2,
  skip_existing = TRUE,
  cleanup = FALSE,
  verbose = TRUE
)
#> 
#> ── Creating brain atlas "yeo7" ─────────────────────────────────────────────────
#> ℹ Input files: '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/lh.Yeo2011_7Networks_N1000.annot' and '/Applications/freesurfer/7.4.1/subjects/fsaverage5/label/rh.Yeo2011_7Networks_N1000.annot'
#> ℹ Setting output directory to '/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7/yeo7_tutorial'
#> ℹ 1/8 Reading annotation files
#> Warning: ! Reading from version `-2`, there may be issues.
#> colortable with 8 entries read (from "MyColorLUT"
#> ℹ 1/8 Reading annotation files
#> Warning: ! Reading from version `-2`, there may be issues.
#> colortable with 8 entries read (from "MyColorLUT"
#> ℹ 1/8 Reading annotation files✔ 1/8 Reading annotation files [62ms]
#> 
#> ℹ 2/8 Taking full brain snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961353d170a2.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613684c59af.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961372342ea1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136f4c0939.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961354f5602f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961375410fa0.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133ef65658.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134b4f6479.html screenshot completed
#> Warning: SequentialFuture (<unnamed-1>) added, removed, or modified
#> connections. A future expression must close any opened connections and must not
#> close connections it did not open. Details: 2 connection added ([index=5,
#> description=/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7/supervisor_stdin9613e9f87be,
#> class=fifo, mode=w+, text=text, opened=opened, can.read=yes, can.write=yes];
#> [index=6,
#> description=/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T//RtmpuOHgz7/supervisor_stdout9613b88d272,
#> class=fifo, mode=w+, text=text, opened=opened, can.read=yes, can.write=yes]), 0
#> connection removed (<none>), 0 connection replaced (<none>). See also
#> help("future.options", package = "future") [future <unnamed-1>
#> (f530eb2c5e3f198e4a731d085f98f690-1); on
#> f530eb2c5e3f198e4a731d085f98f690@Athanasias-MacBook-Air.local<38419>]
#> Warning: UNRELIABLE VALUE: Future (<unnamed-1>) unexpectedly generated random
#> numbers without specifying argument 'seed'. There is a risk that those random
#> numbers are not statistically sound and the overall results might be invalid.
#> To fix this, specify 'seed=TRUE'. This ensures that proper, parallel-safe
#> random numbers are produced. To disable this check, use 'seed=NULL', or set
#> option 'future.rng.onMisuse' to "ignore". [future <unnamed-1>
#> (f530eb2c5e3f198e4a731d085f98f690-1); on
#> f530eb2c5e3f198e4a731d085f98f690@Athanasias-MacBook-Air.local<38419>]
#> ✔ 2/8 Taking full brain snapshots [21.5s]
#> 
#> ℹ 3/8 Taking region snapshots
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613798ef7e1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961329d3a6cd.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961318e8eef4.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133cab0a7a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613475b6c0e.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961320a2c064.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961330b0bd51.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613396428d3.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131078cf9f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961361da2633.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961336868e90.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613484e974.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961345943bad.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961351d65b30.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961360587ba5.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961377ea1815.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136e29635f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961325619ec7.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137e24539b.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131f4d7c30.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96135a52dcab.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613d402b1.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613204485cd.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613146efa22.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131c414039.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132557d1ca.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961310f9bd68.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961367307fee.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132b1fa6.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613428e1367.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613900c092.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613409186eb.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961342818321.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961329f76b9c.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134a3ad04a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137c2e7035.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961319c748be.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131d4e9502.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961318439a62.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961359bb99c0.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613cbedfef.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961361e426f9.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96139a375cd.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136634e86f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137eb3a311.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136aeee00f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613143f28bd.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133f57f3ef.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613712fccb3.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96133ee5ac22.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96134be8ba78.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131aa2de53.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136950a7d.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613c0ad732.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961350576ca3.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137bbd982f.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96132987b73a.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961328391a87.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96136fe90465.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613308272bd.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file9613792c54b2.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96131aa86812.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file961362abb7c8.html screenshot completed
#> file:////private/var/folders/y5/zlbbcqn56gx1tcg6xfb425100000gp/T/RtmpuOHgz7/file96137975eec7.html screenshot completed
#> ✔ 3/8 Taking region snapshots [2m 31.4s]
#> 
#> ℹ 4/8 Isolating regions
#> ✔ 4/8 Isolating regions [11.3s]
#> 
#> ℹ 5/8 Extracting contours
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> Warning: [rast] unknown extent
#> ✔ 5/8 Extracting contours [3.8s]
#> 
#> ℹ 6/8 Smoothing contours (smoothness = 2)
#> ✔ 6/8 Smoothing contours (smoothness = 2) [2.9s]
#> 
#> ℹ 7/8 Reducing vertices (tolerance = 1)
#> ✔ 7/8 Reducing vertices (tolerance = 1) [657ms]
#> 
#> ℹ 8/8 Building atlas data
#> ✔ 8/8 Building atlas data [80ms]
#> 
#> ✔ Brain atlas created with 16 regions
#> ℹ Pipeline completed in 3.2 minutes

yeo7_raw
#> 
#> ── yeo7 ggseg atlas ────────────────────────────────────────────────────────────
#> Type: cortical
#> Regions: 8
#> Hemispheres: left, right
#> Views: inferior, lateral, medial, superior
#> Palette: ✔
#> Rendering: ✔ ggseg
#> ✔ ggseg3d (vertices)
#> ────────────────────────────────────────────────────────────────────────────────
#> # A tibble: 16 × 3
#>    hemi  region      label         
#>    <chr> <chr>       <chr>         
#>  1 left  7Networks_1 lh_7Networks_1
#>  2 left  7Networks_2 lh_7Networks_2
#>  3 left  7Networks_3 lh_7Networks_3
#>  4 left  7Networks_4 lh_7Networks_4
#>  5 left  7Networks_5 lh_7Networks_5
#>  6 left  7Networks_6 lh_7Networks_6
#>  7 left  7Networks_7 lh_7Networks_7
#>  8 left  unknown     lh_unknown    
#>  9 right 7Networks_1 rh_7Networks_1
#> 10 right 7Networks_2 rh_7Networks_2
#> 11 right 7Networks_3 rh_7Networks_3
#> 12 right 7Networks_4 rh_7Networks_4
#> 13 right 7Networks_5 rh_7Networks_5
#> 14 right 7Networks_6 rh_7Networks_6
#> 15 right 7Networks_7 rh_7Networks_7
#> 16 right unknown     rh_unknown
```

A few things to note about the parameters:

- **`tolerance`** controls vertex reduction in the output polygons. Higher values mean simpler polygons with fewer vertices.
- **`smoothness`** controls contour smoothing. Higher values produce rounder edges.
- **`cleanup = FALSE`** keeps intermediate files (screenshots, contour images) so you can re-run later steps without redoing the slow screenshot capture.
- **`skip_existing = TRUE`** reuses existing intermediate files when resuming an interrupted run.

## Step 3: Post-processing

The raw atlas contains every region from the annotation, including labels like "unknown" and "corpuscallosum" that you typically want as background outlines rather than filled regions.

`atlas_region_contextual()` keeps the geometry for spatial reference but removes the region from `$core`, so it renders as an outline:


``` r
yeo7_raw <- yeo7_raw |>
  atlas_region_contextual("cortex", match_on = "label") |>
  atlas_region_contextual("unknown", match_on = "label") |>
  atlas_region_contextual("corpuscallosum", match_on = "label") |>
  atlas_region_contextual("FreeSurfer_Defined_Medial_Wall", match_on = "label")
```

Gather views into a compact layout:


``` r
yeo7_raw <- yeo7_raw |>
  atlas_view_gather()
```

## Step 4: Adding metadata

The raw atlas has region names derived from the annotation file.
For the Yeo atlas, the annotation labels are numeric network IDs.
We can map them to descriptive network names:


``` r
yeo7_metadata <- data.frame(
  label = c(
    "7Networks_1", "7Networks_2", "7Networks_3", "7Networks_4",
    "7Networks_5", "7Networks_6", "7Networks_7"
  ),
  region_pretty = c(
    "visual", "somatomotor", "dorsal attention",
    "ventral attention", "limbic", "frontoparietal", "default"
  )
)

core_with_meta <- yeo7_raw$core |>
  left_join(yeo7_metadata, by = "label") |>
  mutate(region = coalesce(region_pretty, region)) |>
  select(hemi, region, label)
```

## Step 5: Rebuilding the atlas

Construct the final atlas from the modified core:


``` r
yeo7 <- brain_atlas(
  atlas = yeo7_raw$atlas,
  type = yeo7_raw$type,
  palette = yeo7_raw$palette,
  core = core_with_meta,
  data = yeo7_raw$data
)

yeo7
#> 
#> ── yeo7 ggseg atlas ────────────────────────────────────────────────────────────
#> Type: cortical
#> Regions: 7
#> Hemispheres: left, right
#> Views: inferior, lateral, medial, superior
#> Palette: ✔
#> Rendering: ✔ ggseg
#> ✔ ggseg3d (vertices)
#> ────────────────────────────────────────────────────────────────────────────────
#> # A tibble: 14 × 3
#>    hemi  region      label         
#>    <chr> <chr>       <chr>         
#>  1 left  7Networks_1 lh_7Networks_1
#>  2 left  7Networks_2 lh_7Networks_2
#>  3 left  7Networks_3 lh_7Networks_3
#>  4 left  7Networks_4 lh_7Networks_4
#>  5 left  7Networks_5 lh_7Networks_5
#>  6 left  7Networks_6 lh_7Networks_6
#>  7 left  7Networks_7 lh_7Networks_7
#>  8 right 7Networks_1 rh_7Networks_1
#>  9 right 7Networks_2 rh_7Networks_2
#> 10 right 7Networks_3 rh_7Networks_3
#> 11 right 7Networks_4 rh_7Networks_4
#> 12 right 7Networks_5 rh_7Networks_5
#> 13 right 7Networks_6 rh_7Networks_6
#> 14 right 7Networks_7 rh_7Networks_7
```


``` r
brain_regions(yeo7) |> sort()
#> [1] "7Networks_1" "7Networks_2" "7Networks_3" "7Networks_4" "7Networks_5"
#> [6] "7Networks_6" "7Networks_7"
```

## Applying the same pattern to larger atlases

The Yeo 7-network atlas runs in minutes because it has few regions.
Larger atlases like aparc (34 regions/hemisphere) or aparc.a2009s (75 regions/hemisphere) take longer but follow the same pattern.
Enable parallel processing before running:


``` r
library(future)
plan(multisession, workers = 4)

library(progressr)
handlers("cli")
handlers(global = TRUE)

dk_annots <- file.path(
  subjects_dir, "fsaverage5", "label",
  c("lh.aparc.annot", "rh.aparc.annot")
)

dk <- create_cortical_atlas(
  input_annot = dk_annots,
  atlas_name = "dk",
  output_dir = "data-raw"
)

plan(sequential)
```

The screenshot and contour extraction steps parallelize across regions, so more workers means faster completion --- up to a point.
Four workers is a reasonable default for most machines.

## Saving

Once you're satisfied with the atlas, save it as package data:


``` r
usethis::use_data(yeo7, overwrite = TRUE, compress = "xz")
```

The `compress = "xz"` flag gives the best compression for sf geometry data.
