---
title: "Creating tract atlases"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating tract atlases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

Tract atlases represent white matter pathways derived from diffusion MRI tractography.
Unlike cortical or subcortical atlases where regions are contiguous surfaces, tracts are tube-like structures that follow streamline bundles through the brain.

This tutorial shows how to turn tractography files into a brain atlas with 3D tube meshes and optional 2D projection views.

```{r}
#| label: load-libraries
library(ggsegExtra)
library(ggseg)
library(ggseg3d)
library(ggplot2)
```

## Supported file formats

The function reads two tractography formats:

- **TRK** (TrackVis): Common in FreeSurfer's TRACULA and other tools
- **TCK** (MRtrix): Native format for MRtrix3 tractography

Both formats store streamlines as sequences of 3D coordinates.

## Basic tract atlas

Create an atlas from tractography files:

```{r}
#| label: basic
tract_files <- c(
  "cst_left.trk",
  "cst_right.trk",
  "ilf_left.trk",
  "ilf_right.trk"
)

atlas <- create_tract_atlas(
  tract_files = tract_files,
  include_geometry = FALSE
)

ggseg3d(atlas = atlas, hemisphere = "subcort") |>
  add_glassbrain(opacity = 0.15)
```

The function reads each tract file, computes a centerline from the streamlines, and generates a tube mesh around it.

## Naming tracts

By default, tract names come from filenames.
Override them explicitly:

```{r}
#| label: naming
atlas <- create_tract_atlas(
  tract_files = tract_files,
  tract_names = c("CST left", "CST right", "ILF left", "ILF right")
)
```

## Centerline extraction

When a tract contains many streamlines, the function extracts a single representative centerline.
Two methods are available:

**mean** (default): Resamples all streamlines to the same number of points and averages coordinates.
Fast, produces smooth centerlines, but can be pulled by outliers.

**medoid**: Selects the single streamline most similar to all others.
Slower, but more robust to outliers.

```{r}
#| label: centerline
atlas_mean <- create_tract_atlas(
  tract_files = tract_files,
  centerline_method = "mean"
)

atlas_medoid <- create_tract_atlas(
  tract_files = tract_files,
  centerline_method = "medoid"
)
```

For clean tractography with consistent streamlines, "mean" works well.
For noisy data with outlier streamlines, try "medoid".

## Tube radius

The `tube_radius` parameter controls tube thickness:

**Fixed radius**: A single number applies uniform thickness along the entire tract.

```{r}
#| label: fixed-radius
atlas <- create_tract_atlas(
  tract_files = tract_files,
  tube_radius = 0.8
)
```

**Density-based radius**: Set `tube_radius = "density"` to make the tube thicker where more streamlines pass through.
This visualises tract consistency - dense regions appear thicker.

```{r}
#| label: density-radius
atlas <- create_tract_atlas(
  tract_files = tract_files,
  tube_radius = "density",
  density_radius_range = c(0.3, 1.2)
)
```

The `density_radius_range` controls the minimum and maximum radius.

## Tube smoothness

The `tube_segments` parameter controls how many vertices form the tube circumference.
Higher values produce smoother tubes but larger meshes:

```{r}
#| label: segments
atlas_rough <- create_tract_atlas(
  tract_files = tract_files,
  tube_segments = 6
)

atlas_smooth <- create_tract_atlas(
  tract_files = tract_files,
  tube_segments = 16
)
```

The default (8) balances smoothness and file size.

## Centerline resolution

The `n_points` parameter controls how many points define the centerline.
More points capture finer detail but produce larger tube meshes:

```{r}
#| label: resolution
atlas <- create_tract_atlas(
  tract_files = tract_files,
  n_points = 100
)
```

The default (50) works well for most tracts.

## 2D projections

For 2D plots, enable geometry extraction with a reference segmentation:

```{r}
#| label: 2d-geometry
output_dir <- withr::local_tempdir()

atlas <- create_tract_atlas(
  tract_files = tract_files,
  include_geometry = TRUE,
  aseg_file = "aparc+aseg.nii.gz",
  output_dir = output_dir,
  coords_are_voxels = TRUE
)

plot(atlas)
```

The `aseg_file` provides cortex outlines for anatomical context.
The function creates projections that collapse tract extent along one axis.

### Coordinate space

Set `coords_are_voxels = TRUE` if your streamline coordinates are in voxel space (common for TRACULA output).
Set it to `FALSE` (default) if coordinates are in RAS world space.

### Custom projection views

By default, the function creates six projection views.
Override with custom views:

```{r}
#| label: custom-views
views <- data.frame(
  name = c("superior", "anterior"),
  type = c("axial", "coronal"),
  start = c(60, 80),
  end = c(120, 140),
  stringsAsFactors = FALSE
)

cortex_slices <- data.frame(
  x = c(NA, NA),
  y = c(128, 110),
  z = c(90, NA),
  view = c("axial", "coronal"),
  name = c("superior", "anterior"),
  stringsAsFactors = FALSE
)

atlas <- create_tract_atlas(
  tract_files = tract_files,
  include_geometry = TRUE,
  aseg_file = "aparc+aseg.nii.gz",
  views = views,
  cortex_slices = cortex_slices
)
```

The `start` and `end` parameters define which slice range to project.
Unlike subcortical atlases that show single slices, tract projections collapse a range of slices to show the full tract extent.

## Using coordinate matrices directly

If you already have centerline coordinates in R, skip file reading:

```{r}
#| label: matrices
centerlines <- list(
  cst_left = matrix(c(...), ncol = 3),
  cst_right = matrix(c(...), ncol = 3)
)

atlas <- create_tract_atlas(
  tract_files = centerlines
)
```

Each matrix should have columns for x, y, z coordinates.

## Colours

Provide custom colours for each tract:

```{r}
#| label: colours
atlas <- create_tract_atlas(
  tract_files = tract_files,
  tract_names = c("CST left", "CST right", "ILF left", "ILF right"),
  colours = c("#E74C3C", "#E74C3C", "#3498DB", "#3498DB")
)
```

Without explicit colours, the function assigns a rainbow palette.

## Debugging

**No streamlines read**: Check that the file format is correct (TRK or TCK).
Open the file in TrackVis or mrview to verify it contains data.

**Centerline looks wrong**: If "mean" produces an odd path, the tract may have inconsistent streamlines.
Try "medoid" or filter streamlines before input.

**Tube mesh looks twisted**: The parallel transport algorithm should prevent twisting, but very sharp bends can cause artifacts.
Increase `n_points` to add more segments through sharp turns.

**2D projections miss the tract**: Check `coords_are_voxels`.
If coordinates are in world space but you set it to TRUE (or vice versa), the tract may project outside the volume bounds.

## Complete example: TRACULA tracts

Here is the full pipeline using FreeSurfer's TRACULA training data:

```{r}
#| label: tracula-complete
library(ggsegExtra)
library(ggseg3d)
library(ggplot2)

tract_dir <- file.path(
  freesurfer::get_fs_home(),
  "trctrain/hcp/mgh_1017/mni"
)

tract_files <- file.path(tract_dir, c(
  "lh.cst.bbr.prep.trk",
  "rh.cst.bbr.prep.trk",
  "lh.ilf.bbr.prep.trk",
  "rh.ilf.bbr.prep.trk",
  "cc.genu.bbr.prep.trk",
  "cc.splenium.bbr.prep.trk"
))

tract_names <- c(
  "CST left", "CST right",
  "ILF left", "ILF right",
  "CC genu", "CC splenium"
)

output_dir <- withr::local_tempdir()

atlas <- create_tract_atlas(
  tract_files = tract_files,
  tract_names = tract_names,
  tube_radius = 0.8,
  tube_segments = 12,
  centerline_method = "mean",
  n_points = 50,
  include_geometry = TRUE,
  aseg_file = file.path(tract_dir, "aparc+aseg.nii.gz"),
  output_dir = output_dir,
  coords_are_voxels = TRUE
)

ggseg3d(atlas = atlas, hemisphere = "subcort") |>
  add_glassbrain(hemisphere = c("left", "right"), opacity = 0.15) |>
  pan_camera("right lateral")

ggplot() +
  geom_brain(atlas = atlas, show.legend = FALSE) +
  theme_void()
```
