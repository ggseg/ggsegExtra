---
title: "Tutorial: Creating a subcortical atlas"
format: html
---

```{r}
#| label: setup
#| include: false
can_run <- set_tutorial_options()
```

Subcortical atlases represent the structures beneath the cortical surface: thalamus, hippocampus, amygdala, caudate, putamen, and others.
They come from volumetric segmentations like FreeSurfer's `aseg.mgz`, where each voxel is assigned a label.

The pipeline tessellates labelled voxel regions into 3D meshes and (optionally) creates 2D projection views that collapse a slab of the volume onto a single plane.

This tutorial recreates the aseg atlas --- the same pipeline behind `data-raw/make_aseg_atlas.R` in ggseg.formats.

## What you need

- FreeSurfer installed with the `fsaverage5` subject
- ImageMagick for 2D geometry extraction
- Chrome/Chromium for 3D screenshots

```{r}
#| label: load-libraries
#| eval: !expr can_run
library(ggseg.extra)
library(ggseg.formats)
library(dplyr)
```

```{r}
#| label: setup-paths
#| eval: !expr can_run
fs_dir <- freesurfer::fs_dir()
subjects_dir <- file.path(fs_dir, "subjects")

aseg_volume <- file.path(subjects_dir, "fsaverage5", "mri", "aseg.mgz")
color_lut <- file.path(fs_dir, "ASegStatsLUT.txt")

if (!file.exists(color_lut)) {
  color_lut <- file.path(fs_dir, "FreeSurferColorLUT.txt")
}
```

## Creating the atlas

`create_subcortical_from_volume()` takes a segmentation volume and a colour lookup table.
The pipeline tessellates each labelled region into a 3D mesh, then creates 2D projection views:

```{r}
#| label: create-atlas
#| eval: !expr can_run

aseg_raw <- create_subcortical_from_volume(
  input_volume = aseg_volume,
  input_lut = color_lut,
  atlas_name = "aseg"
)

aseg_raw
```

The default pipeline creates six projection views focused on the subcortical range:
axial inferior, axial superior, coronal posterior, coronal anterior, sagittal left, and sagittal right.
Each view collapses a slab of the volume onto a single plane, giving you spatial context without the complexity of individual slices.

## Removing unwanted regions

The aseg segmentation contains everything --- cortex, white matter, ventricles, CSF.
For a subcortical atlas, most of these are noise.
Remove them:

```{r}
#| label: remove-regions
#| eval: !expr can_run
aseg_raw <- aseg_raw |>
  atlas_region_remove("White-Matter", match_on = "label") |>
  atlas_region_remove("WM-hypointensities", match_on = "label") |>
  atlas_region_remove("-Ventricle", match_on = "label") |>
  atlas_region_remove("-Vent$", match_on = "label") |>
  atlas_region_remove("CSF", match_on = "label") |>
  atlas_region_remove("Cerebral-Cortex", match_on = "label")
```

Patterns are regular expressions, so `-Vent$` matches "3rd-Vent" and "4th-Vent" without catching "Ventral-DC."

## Setting context regions

The cortex works well as a background outline --- it shows where subcortical structures sit relative to the brain surface without competing for colour:

```{r}
#| label: context
#| eval: !expr can_run
aseg_raw <- aseg_raw |>
  atlas_region_contextual("Cortex", match_on = "label")
```

## Selecting views

Not all projection views are equally useful.
Keep the ones that show your structures best:

```{r}
#| label: select-views
#| eval: !expr can_run
aseg_raw <- aseg_raw |>
  atlas_view_keep("axial_3|axial_5|coronal_2|coronal_3|coronal_4|sagittal")
```

## Cleaning up the layout

Gather views into a compact arrangement:

```{r}
#| label: gather
#| eval: !expr can_run
aseg_raw <- aseg_raw |>
  atlas_view_gather()
```

## Adding metadata

The raw labels are technical identifiers like "Left-Thalamus-Proper."
Join human-readable names and structural groupings:

```{r}
#| label: metadata
#| eval: !expr can_run
normalize_region <- function(x) {
  ifelse(
    is.na(x),
    NA_character_,
    x |>
      tolower() |>
      gsub("-", " ", x = _) |>
      gsub("_", " ", x = _) |>
      gsub("left |right ", "", x = _) |>
      trimws()
  )
}

aseg_metadata <- data.frame(
  region = c(
    "Thalamus-Proper", "Caudate", "Putamen", "Pallidum",
    "Hippocampus", "Amygdala", "Accumbens-area", "VentralDC",
    "Brain-Stem"
  ),
  label_pretty = c(
    "thalamus", "caudate", "putamen", "pallidum",
    "hippocampus", "amygdala", "nucleus accumbens", "ventral DC",
    "brain stem"
  ),
  structure = c(
    "diencephalon", "basal ganglia", "basal ganglia", "basal ganglia",
    "limbic", "limbic", "basal ganglia", "diencephalon",
    "brainstem"
  )
)

core_with_meta <- aseg_raw$core |>
  mutate(region_key = normalize_region(region)) |>
  left_join(
    aseg_metadata |>
      mutate(region_key = normalize_region(region)) |>
      select(region_key, label_pretty, structure),
    by = "region_key"
  ) |>
  mutate(region = coalesce(label_pretty, region)) |>
  select(hemi, region, label, structure)
```

## Rebuilding and saving

Construct the final atlas from modified components:

```{r}
#| label: rebuild
#| eval: !expr can_run
aseg <- ggseg_atlas(
  atlas = aseg_raw$atlas,
  type = aseg_raw$type,
  palette = aseg_raw$palette,
  core = core_with_meta,
  data = aseg_raw$data
)

aseg
```

```{r}
#| label: inspect
#| eval: !expr can_run
brain_labels(aseg)

table(aseg$core$structure)
```

```{r}
#| label: plot
#| eval: !expr can_run
#| fig-cap: "Subcortical aseg atlas plotted with ggseg."
#| fig-alt: "2D brain atlas plot showing subcortical structures including thalamus, caudate, putamen, hippocampus, and amygdala across axial, coronal, and sagittal projection views."
#| fig-width: 10
#| fig-height: 8

plot(aseg)
```
