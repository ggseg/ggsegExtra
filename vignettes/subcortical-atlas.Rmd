---
title: "Creating subcortical atlases"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating subcortical atlases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

Subcortical atlases represent structures beneath the cortical surface: thalamus, amygdala, hippocampus, basal ganglia, ventricles.
They come from volumetric segmentations like FreeSurfer's `aseg.mgz` where each voxel is assigned a label.

This tutorial shows how to turn a volumetric segmentation into a brain atlas with 3D meshes and optional 2D slice views.

```{r}
#| label: load-libraries
library(ggsegExtra)
library(ggseg)
library(ggseg3d)
library(ggplot2)
library(dplyr)
```

## Quick 3D-only atlas

For fast iteration, create meshes without 2D slice geometry:

```{r}
#| label: 3d-only
atlas <- create_subcortical_atlas(
  volume_file = file.path(freesurfer::fs_subj_dir(), "fsaverage5/mri/aseg.mgz"),
  include_geometry = FALSE
)

ggseg3d(atlas = atlas, hemisphere = "subcort") |>
  add_glassbrain()
```

The function extracts each labelled region from the volume, creates a surface mesh using FreeSurfer's tessellation pipeline, and simplifies it to a manageable vertex count.

## Full atlas with 2D slices

For 2D plotting, specify which slices to capture:

```{r}
#| label: full-atlas
output_dir <- withr::local_tempdir()

slices <- data.frame(
  x = c(130, 122, 122),
  y = c(130, 235, 112),
  z = c(130, 100, 106),
  view = c("axial", "sagittal", "coronal"),
  stringsAsFactors = FALSE
)

atlas <- create_subcortical_atlas(
  volume_file = file.path(freesurfer::fs_subj_dir(), "fsaverage5/mri/aseg.mgz"),
  include_geometry = TRUE,
  slices = slices,
  output_dir = output_dir
)

plot(atlas, alpha = 0.8)
```

## Choosing slices

Slice selection determines what appears in your 2D plots.
The coordinates are in voxel space (typically 0-255 for a 256x256x256 volume).

Find good slice positions by exploring the volume in freeview:

```bash
freeview -v $SUBJECTS_DIR/fsaverage5/mri/aseg.mgz
```

Note the coordinates where structures of interest are visible.
Different structures appear at different depths:

```{r}
#| label: multiple-slices
slices <- data.frame(
  x = c(130, 130, 130, 100, 160),
  y = c(130, 100, 160, 130, 130),
  z = c(80, 100, 100, 100, 100),
  view = c("axial", "coronal", "coronal", "sagittal", "sagittal"),
  stringsAsFactors = FALSE
)

atlas <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  slices = slices,
  include_geometry = TRUE
)
```

Each row in the slices data frame becomes a separate panel in the 2D plot.

## Filtering regions

The default aseg contains structures you may not want: cerebral cortex, white matter, ventricles.
Filter them out:

**Option 1**: Specify which labels to include:

```{r}
#| label: filter-labels
deep_nuclei <- c(
  10, 11, 12, 13, 17, 18, 26, 28,
  49, 50, 51, 52, 53, 54, 58, 60
)

atlas <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  labels = deep_nuclei,
  include_geometry = FALSE
)
```

**Option 2**: Create the full atlas, then filter:

```{r}
#| label: filter-after
atlas <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  include_geometry = TRUE
)

unwanted <- c(
  "Left-Cerebral-White-Matter", "Right-Cerebral-White-Matter",
  "Left-Cerebral-Cortex", "Right-Cerebral-Cortex"
)

atlas$core <- filter(atlas$core, !label %in% unwanted)
atlas$data$meshes <- filter(atlas$data$meshes, !label %in% unwanted)

if (!is.null(atlas$data$sf)) {
  atlas$data$sf <- filter(atlas$data$sf, !label %in% unwanted)
}
```

The second approach is useful when you want to inspect everything first, then decide what to keep.

## Mesh simplification

Raw tessellated meshes can have thousands of vertices.
The `target_vertices` parameter controls simplification:

```{r}
#| label: simplification
atlas_detailed <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  target_vertices = 1000,
  include_geometry = FALSE
)

atlas_light <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  target_vertices = 200,
  include_geometry = FALSE
)
```

Lower values produce smaller files and faster rendering but lose surface detail.
The default (400) works well for most structures.

Mesh simplification requires the Rvcg package:

```{r}
#| label: rvcg
#| eval: false
install.packages("Rvcg")
```

Without Rvcg, meshes are returned unsimplified with a warning.

## Custom colour tables

The function reads colours from a FreeSurfer lookup table.
If your segmentation uses custom labels, provide a matching colour table:

```{r}
#| label: custom-lut
atlas <- create_subcortical_atlas(
  volume_file = "path/to/custom_seg.mgz",
  color_lut = "path/to/custom_lut.txt"
)
```

The lookup table format matches FreeSurfer's standard:

```
# Label  Name               R   G   B   A
10       Left-Thalamus      0   118 14  0
11       Left-Caudate       122 186 220 0
```

## Tuning 2D polygon quality

The same parameters as cortical atlases control 2D output:

```{r}
#| label: tuning
atlas <- create_subcortical_atlas(
  volume_file = "path/to/aseg.mgz",
  slices = slices,
  smoothness = 3,
  tolerance = 0.5,
  include_geometry = TRUE
)
```

Subcortical structures are often small in 2D slices, so lower smoothness values may work better than for cortical atlases.

## Debugging

**No meshes created**: Check that your volume contains non-zero labels.
Use `freesurfer::readmgz()` or freeview to inspect.

**Meshes look fragmented**: Small or disconnected label regions may tessellate poorly.
Try increasing the label threshold or using a smoother segmentation.

**2D slices miss structures**: Adjust slice coordinates.
Subcortical structures occupy specific depth ranges - you may need multiple slices at different z positions.

**Colours don't match**: Check that your colour lookup table matches the label IDs in your volume.
The label ID in the volume must match the first column in the LUT.

## Complete example: aseg atlas

Here is the full pipeline for creating an atlas of deep brain structures:

```{r}
#| label: aseg-complete
library(ggsegExtra)
library(dplyr)

output_dir <- withr::local_tempdir()

slices <- data.frame(
  x = c(130, 122, 122),
  y = c(130, 235, 112),
  z = c(130, 100, 106),
  view = c("axial", "sagittal", "coronal"),
  stringsAsFactors = FALSE
)

deep_nuclei <- c(
  10, 11, 12, 13, 17, 18, 26, 28,
  49, 50, 51, 52, 53, 54, 58, 60
)

aseg <- create_subcortical_atlas(
  volume_file = file.path(freesurfer::fs_subj_dir(), "fsaverage5/mri/aseg.mgz"),
  labels = deep_nuclei,
  slices = slices,
  target_vertices = 400,
  output_dir = output_dir,
  include_geometry = TRUE
)

aseg$core <- aseg$core |>
  mutate(
    region = gsub("-", " ", region),
    region = tolower(region),
    region = gsub("left ", "", region),
    region = gsub("right ", "", region)
  )

plot(aseg, alpha = 0.8)

ggseg3d(atlas = aseg, hemisphere = "subcort") |>
  add_glassbrain(opacity = 0.1)
```
