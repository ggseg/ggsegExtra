<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contributing: creating new polygon ggseg-atlases • ggsegExtra</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Contributing: creating new polygon ggseg-atlases">
<meta property="og:description" content="ggsegExtra">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ggsegExtra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ggsegExtra.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/customatlas.html">Contributing: creating new polygon ggseg-atlases</a>
    </li>
    <li>
      <a href="../articles/customatlas3d.html">Contributing: creating new tridimensional ggseg3d-atlases</a>
    </li>
    <li>
      <a href="../articles/ggsegrepo.html">Contribute: prepare a repository for the atlas</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LCBC-UiO/ggsegExtra/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="customatlas_files/header-attrs-2.1.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Contributing: creating new polygon ggseg-atlases</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LCBC-UiO/ggsegExtra/blob/master/vignettes/customatlas.Rmd"><code>vignettes/customatlas.Rmd</code></a></small>
      <div class="hidden name"><code>customatlas.Rmd</code></div>

    </div>

    
    
<div id="creating-ggseg-atlas-from-a-ggseg3d-atlas" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-ggseg-atlas-from-a-ggseg3d-atlas" class="anchor"></a>Creating ggseg-atlas from a ggseg3d-atlas</h2>
<p>The best way to create a ggseg-atlas with little manual intervention, is to first make a <a href="https://lcbc-uio.github.io/ggsegExtra/articles/customatlas3d.html">ggseg3d-atlas</a>, and then convert that to ggseg-atlas. The entire process can take anything from 10minutes, depending on the number of segmentations in the atlas. More segmentations means longer time.</p>
<p>Once you have a ggseg3d-atlas, the function <code>ggseg3d_2_ggseg()</code> can convert that into polygons ready for ggseg.</p>
<div id="prerequisites" class="section level3">
<h3 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h3>
<ul>
<li>R</li>
<li><a href="https://imagemagick.org/index.php">Imagemagick</a></li>
<li><a href="https://github.com/plotly/orca">orca</a></li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">dt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/make_ggseg3d_2_ggseg.html">make_ggseg3d_2_ggseg</a></span>(
  <span class="kw">ggseg3d_atlas</span> <span class="kw">=</span> <span class="no">dk_3d</span>,
  <span class="kw">steps</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">7</span>,
  <span class="kw">output_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(),
  <span class="kw">smoothness</span> <span class="kw">=</span> <span class="fl">10</span>,
  <span class="kw">tolerance</span> <span class="kw">=</span> <span class="fl">0</span>,
  <span class="kw">cleanup</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>The function takes few arguments, but does quite a lot in the background. It needs an object that is a ggseg3d-atlas, ad will work with no other input changed. We recommen changing the <code>output_dir</code> to a folder you can keep track of to see how the intermediate results look like. This also makes it possible for you to use the <code>steps</code> argument. If early steps have been run succesfully, you can skip them and only run later steps. Re-running steps 5:7 might be necessary to find a good balance between <code>smoothness</code> of the polygons for nicer looking parcellations, and vertex reductions through <code>tolerance</code> to reduce file size. We recommend trying several combinations untill you have something that looks nice. Vertex reduction is particularly important, as it significantly reduces the atlas data size, thus making it much faster to plot. This is important for incorporating into Shiny apps, or if you have very many facets to plot. We’d generally recommend a 2d-atlas not have much more than 10k vertices.</p>
<p>Once the data is returned, we recommend doing some data cleaning, particularly of the <code>region</code> column. This column should ideally have human readable names, be short, and have space rather than delimiters. This is to enable nicer labelling when plotting. Once this is done, try plotting it with ggseg.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">dt</span> <span class="kw">&lt;-</span> <span class="fu">ggseg</span>(<span class="kw">atlas</span> <span class="kw">=</span> <span class="no">dk</span>)</pre></body></html></div>
</div>
</div>
<div id="skipping-ggseg3d-atlas" class="section level2">
<h2 class="hasAnchor">
<a href="#skipping-ggseg3d-atlas" class="anchor"></a>Skipping ggseg3d-atlas</h2>
<p>This pipeline is contributed by <a href="https://github.com/bbuchsbaum">bbuchsbaum</a>. It is still quite error prone, but was instrumental to creating the above funtionality.</p>
<p>The Harvard-Oxford atlas is available with FSL. Here is a process for converting the cortical parts, via FreeSurfer, to a ggseg format.</p>
<div id="prerequisites-1" class="section level3">
<h3 class="hasAnchor">
<a href="#prerequisites-1" class="anchor"></a>Prerequisites</h3>
<p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/">FSL</a>, <a href="https://surfer.nmr.mgh.harvard.edu/">FreeSurfer</a>, <a href="https://www.humanconnectome.org/software/connectome-workbench">connectome workbench</a>, <a href="https://www.gnu.org/software/parallel/">parallel</a>, <a href="https://imagemagick.org/index.php">ImageMagick</a>, <a href="https://www.r-project.org/">R</a>.</p>
</div>
<div id="converting-to-freesurfer-and-fixing" class="section level3">
<h3 class="hasAnchor">
<a href="#converting-to-freesurfer-and-fixing" class="anchor"></a>Converting to FreeSurfer and fixing</h3>
<ol style="list-style-type: decimal">
<li><p>Take a copy of the fsaverage folder, and set up SUBJECTS_DIR to point to the folder containing the fsaverage copy.</p></li>
<li><p>Import the atlas as a surface</p></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="bu">cd</span> <span class="va">${SUBJECTS_DIR}</span>/fsaverage/mri</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">mri_vol2surf</span> --sd <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/../.. --src <span class="va">${FSLDIR}</span>/data/atlases/HarvardOxford/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz --mni152reg --out  harvard_oxford_surf_rh.mgh --hemi rh --projfrac 0.5</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ex">mri_vol2surf</span> --sd <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/../.. --src <span class="va">${FSLDIR}</span>/data/atlases/HarvardOxford/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz --mni152reg --out harvard_oxford_surf_lh.mgh --hemi lh --projfrac 0.5</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Create a color table. Run an R session in <code>${SUBJECTS_DIR}/fsaverage/mri</code>
</li>
</ol>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"ho_ctab.R"</span>)</pre></body></html></div>
<ol start="4" style="list-style-type: decimal">
<li>Create a series of individual label files</li>
</ol>
<pre><code>mkdir Labels
seq 1 48 | parallel mri_vol2label --c harvard_oxford_surf_rh.mgh --id {} --surf fsaverage rh --l ./Labels/rh_HO_{}.label
seq 1 48 | parallel mri_vol2label --c harvard_oxford_surf_lh.mgh --id {} --surf fsaverage lh --l ./Labels/lh_HO_{}.label
</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Create annotation files</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="va">LABS=$(</span><span class="fu">seq</span> 1 48 <span class="kw">|</span> <span class="ex">parallel</span> echo -n <span class="st">'\ --l ./Labels/lh_HO_{}.label\ '</span><span class="va">)</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ex">mris_label2annot</span> --sd <span class="va">${SUBJECTS_DIR}</span> --s fsaverage --ctab ../label/ho.annot.ctab <span class="va">${LABS}</span> --h lh --a ho</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="va">LABS=$(</span><span class="fu">seq</span> 1 48 <span class="kw">|</span> <span class="ex">parallel</span> echo -n <span class="st">'\ --l ./Labels/rh_HO_{}.label\ '</span><span class="va">)</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="ex">mris_label2annot</span> --sd <span class="va">${SUBJECTS_DIR}</span> --s fsaverage --ctab ../label/ho.annot.ctab <span class="va">${LABS}</span> --h rh --a ho</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Check how the surface looks - note lots of holes etc. Using the 0 prob threshold leads to more bleed to neighboring sulci, which I think is harder to fix.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">vglrun</span> freeview  --surface ../surf/rh.inflated:annot=../label/rh.ho.annot --surface ../surf/lh.inflated:annot=../label/lh.ho.annot</span></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Fill and smooth</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># convert to gifti</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">mris_convert</span> --annot ../label/rh.ho.annot ../surf/rh.inflated ./fsaverage_rh.label.gii</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="ex">mris_convert</span> --annot ../label/lh.ho.annot ../surf/lh.inflated ./fsaverage_lh.label.gii</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="ex">mris_convert</span> --annot ../label/rh.aparc.annot ../surf/rh.inflated ./fsaverage_aparc_rh.label.gii</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="ex">mris_convert</span> --annot ../label/lh.aparc.annot ../surf/lh.inflated ./fsaverage_aparc_lh.label.gii</span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="ex">./smooth_labels.sh</span> fsaverage_lh_10.label.gii inflated_lh.surf.gii fsaverage_lh_10.smooth.label.gii</span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="ex">./smooth_labels.sh</span> fsaverage_rh_10.label.gii inflated_rh.surf.gii fsaverage_rh_10.smooth.label.gii</span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">## Back to viewing with freesurfer</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="kw">for</span> <span class="ex">hemi</span> in lh rh <span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="ex">mris_convert</span> --annot fsaverage_<span class="va">${hemi}</span>_10.smooth.label.gii inflated_<span class="va">${hemi}</span>.surf.gii ./<span class="va">${hemi}</span>.ho.smooth.annot</span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="kw">done</span></span></code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Screengrabs with tksurfer. This can be reun somewhere other than fsaverage.</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">./mkPics.sh</span></span></code></pre></div>
<ol start="9" style="list-style-type: decimal">
<li>Rename the unknowns to medial wall</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">mv</span> PicsHarvardOxford/lh_\?\?\?_med.tif PicsHarvardOxford/lh_medialwall_med.tif</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">mv</span> PicsHarvardOxford/rh_\?\?\?_med.tif PicsHarvardOxford/rh_medialwall_med.tif</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="fu">rm</span> PicsHarvardOxford/*_\?*</span></code></pre></div>
<ol start="10" style="list-style-type: decimal">
<li>Finally, let the R spatial tools work their magic…</li>
</ol>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"mkHO.R"</span>)</pre></body></html></div>
<p>This creates <code>ho_atlas.Rda</code> which contains a couple of data frames, almost ready for inclusion in ggsegExtra.</p>
</div>
<div id="comments" class="section level3">
<h3 class="hasAnchor">
<a href="#comments" class="anchor"></a>Comments</h3>
<p>I suspect something similar will be possible with tkedit, or other viewers that are able to look at the subcortical structures. Otherwise maximal projections after thresholding will probably suffice.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Athanasia Mo Mowinckel, Didac Vidal-Piñeiro.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
