<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Contributing: creating new polygon ggseg-atlases • ggsegExtra</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Contributing: creating new polygon ggseg-atlases">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ggsegExtra</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ggsegExtra.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/system_setup.html">System Setup</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ggseg/ggsegExtra/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Contributing: creating new polygon ggseg-atlases</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ggseg/ggsegExtra/blob/main/vignettes/customatlas.Rmd" class="external-link"><code>vignettes/customatlas.Rmd</code></a></small>
      <div class="d-none name"><code>customatlas.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="creating-ggseg-atlas-from-a-ggseg3d-atlas">Creating ggseg-atlas from a ggseg3d-atlas<a class="anchor" aria-label="anchor" href="#creating-ggseg-atlas-from-a-ggseg3d-atlas"></a>
</h2>
<p>The best way to create a ggseg-atlas with little manual intervention,
is to first make a <a href="customatlas3d.html">ggseg3d-atlas</a>, and
then convert that to ggseg-atlas. The entire process can take anything
from 10minutes, depending on the number of segmentations in the atlas.
More segmentations means longer time.</p>
<p>Once you have a ggseg3d-atlas, the function
<code>ggseg3d_2_ggseg()</code> can convert that into polygons ready for
ggseg.</p>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<ul>
<li>R</li>
<li><a href="https://imagemagick.org/index.php" class="external-link">ImageMagick</a></li>
<li><a href="https://github.com/plotly/orca" class="external-link">orca</a></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_ggseg3d_2_ggseg.html">make_ggseg3d_2_ggseg</a></span><span class="op">(</span></span>
<span>  ggseg3d_atlas <span class="op">=</span> <span class="va">dk_3d</span>,</span>
<span>  steps <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  smoothness <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  tolerance <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  cleanup <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The function takes few arguments, but does quite a lot in the
background. It needs an object that is a ggseg3d-atlas, ad will work
with no other input changed. We recommend changing the
<code>output_dir</code> to a folder you can keep track of to see how the
intermediate results look like. This also makes it possible for you to
use the <code>steps</code> argument. If early steps have been run
successfully, you can skip them and only run later steps. Re-running
steps 5:7 might be necessary to find a good balance between
<code>smoothness</code> of the polygons for nicer looking parcellations,
and vertex reductions through <code>tolerance</code> to reduce file
size. We recommend trying several combinations until you have something
that looks nice. Vertex reduction is particularly important, as it
significantly reduces the atlas data size, thus making it much faster to
plot. This is important for incorporating into Shiny apps, or if you
have very many facets to plot. We’d generally recommend a 2d-atlas not
have much more than 10k vertices.</p>
<p>Once the data is returned, we recommend doing some data cleaning,
particularly of the <code>region</code> column. This column should
ideally have human readable names, be short, and have space rather than
delimiters. This is to enable nicer labelling when plotting. Once this
is done, try plotting it with ggseg.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggseg/man/ggbrain.html" class="external-link">geom_brain</a></span><span class="op">(</span>atlas <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dkt-example">DKT example<a class="anchor" aria-label="anchor" href="#dkt-example"></a>
</h3>
<p>If you have successfully created a 3d atlas <a href="customatlas3d.html">following these steps</a>, you can proceed
using the 3d-atlas to make the 2d-atlas. As long as the 3d atlas is
correctly made, you should have little difficulty making a 2d version.
This pipeline also makes a lot of intermediary files, so be aware of
that.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make atlas ----</span></span>
<span><span class="va">dkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_ggseg3d_2_ggseg.html">make_ggseg3d_2_ggseg</a></span><span class="op">(</span><span class="va">dkt_3d</span>,</span>
<span>                            steps <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,</span>
<span>                            smoothness <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                            tolerance <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>                            output_dir <span class="op">=</span> <span class="st">"~/Desktop"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check that it looks ok.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dkt</span><span class="op">)</span></span></code></pre></div>
<p>Some times, annot-files have a unique colour per hemisphere*region
combination. This is does not work well with ggseg. If you fint that the
parcellations themselves look fine, but that the colours are off, the
atlas palette is surely wrong. You will here need to do some manual
editing of the named character vector in the atlas to fix it.</p>
</div>
</div>
<div class="section level2">
<h2 id="skipping-ggseg3d-atlas">Skipping ggseg3d-atlas<a class="anchor" aria-label="anchor" href="#skipping-ggseg3d-atlas"></a>
</h2>
<p>This pipeline is contributed by <a href="https://github.com/bbuchsbaum" class="external-link">bbuchsbaum</a>. It is still quite
error prone, but was instrumental to creating the above
functionality.</p>
<p>The Harvard-Oxford atlas is available with FSL. Here is a process for
converting the cortical parts, via FreeSurfer, to a ggseg format.</p>
<div class="section level3">
<h3 id="prerequisites-1">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-1"></a>
</h3>
<p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/" class="external-link">FSL</a>, <a href="https://surfer.nmr.mgh.harvard.edu/" class="external-link">FreeSurfer</a>, <a href="https://www.humanconnectome.org/software/connectome-workbench" class="external-link">connectome
workbench</a>, <a href="https://www.gnu.org/software/parallel/" class="external-link">parallel</a>, <a href="https://imagemagick.org/index.php" class="external-link">ImageMagick</a>, <a href="https://www.r-project.org/" class="external-link">R</a>.</p>
</div>
<div class="section level3">
<h3 id="converting-to-freesurfer-and-fixing">Converting to FreeSurfer and fixing<a class="anchor" aria-label="anchor" href="#converting-to-freesurfer-and-fixing"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Take a copy of the fsaverage folder, and set up SUBJECTS_DIR to
point to the folder containing the fsaverage copy.</p></li>
<li><p>Import the atlas as a surface</p></li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="bu">cd</span> <span class="va">${SUBJECTS_DIR}</span>/fsaverage/mri</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="ex">mri_vol2surf</span> <span class="at">--sd</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/../.. <span class="at">--src</span> <span class="va">${FSLDIR}</span>/data/atlases/HarvardOxford/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz <span class="at">--mni152reg</span> <span class="at">--out</span>  harvard_oxford_surf_rh.mgh <span class="at">--hemi</span> rh <span class="at">--projfrac</span> 0.5</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="ex">mri_vol2surf</span> <span class="at">--sd</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/../.. <span class="at">--src</span> <span class="va">${FSLDIR}</span>/data/atlases/HarvardOxford/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz <span class="at">--mni152reg</span> <span class="at">--out</span> harvard_oxford_surf_lh.mgh <span class="at">--hemi</span> lh <span class="at">--projfrac</span> 0.5</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Create a color table. Run an R session in
<code>${SUBJECTS_DIR}/fsaverage/mri</code>
</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"ho_ctab.R"</span><span class="op">)</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Create a series of individual label files</li>
</ol>
<pre><code>mkdir Labels
seq 1 48 | parallel mri_vol2label --c harvard_oxford_surf_rh.mgh --id {} --surf fsaverage rh --l ./Labels/rh_HO_{}.label
seq 1 48 | parallel mri_vol2label --c harvard_oxford_surf_lh.mgh --id {} --surf fsaverage lh --l ./Labels/lh_HO_{}.label
</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Create annotation files</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="va">LABS</span><span class="op">=</span><span class="va">$(</span><span class="fu">seq</span> 1 48 <span class="kw">|</span> <span class="ex">parallel</span> echo <span class="at">-n</span> <span class="st">'\ --l ./Labels/lh_HO_{}.label\ '</span><span class="va">)</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ex">mris_label2annot</span> <span class="at">--sd</span> <span class="va">${SUBJECTS_DIR}</span> <span class="at">--s</span> fsaverage <span class="at">--ctab</span> ../label/ho.annot.ctab <span class="va">${LABS}</span> <span class="at">--h</span> lh <span class="at">--a</span> ho</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="va">LABS</span><span class="op">=</span><span class="va">$(</span><span class="fu">seq</span> 1 48 <span class="kw">|</span> <span class="ex">parallel</span> echo <span class="at">-n</span> <span class="st">'\ --l ./Labels/rh_HO_{}.label\ '</span><span class="va">)</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="ex">mris_label2annot</span> <span class="at">--sd</span> <span class="va">${SUBJECTS_DIR}</span> <span class="at">--s</span> fsaverage <span class="at">--ctab</span> ../label/ho.annot.ctab <span class="va">${LABS}</span> <span class="at">--h</span> rh <span class="at">--a</span> ho</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Check how the surface looks - note lots of holes etc. Using the 0
prob threshold leads to more bleed to neighboring sulci, which I think
is harder to fix.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">vglrun</span> freeview  <span class="at">--surface</span> ../surf/rh.inflated:annot=../label/rh.ho.annot <span class="at">--surface</span> ../surf/lh.inflated:annot=../label/lh.ho.annot</span></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Fill and smooth</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># convert to gifti</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="ex">mris_convert</span> <span class="at">--annot</span> ../label/rh.ho.annot ../surf/rh.inflated ./fsaverage_rh.label.gii</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="ex">mris_convert</span> <span class="at">--annot</span> ../label/lh.ho.annot ../surf/lh.inflated ./fsaverage_lh.label.gii</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="ex">mris_convert</span> <span class="at">--annot</span> ../label/rh.aparc.annot ../surf/rh.inflated ./fsaverage_aparc_rh.label.gii</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="ex">mris_convert</span> <span class="at">--annot</span> ../label/lh.aparc.annot ../surf/lh.inflated ./fsaverage_aparc_lh.label.gii</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="ex">./smooth_labels.sh</span> fsaverage_lh_10.label.gii inflated_lh.surf.gii fsaverage_lh_10.smooth.label.gii</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="ex">./smooth_labels.sh</span> fsaverage_rh_10.label.gii inflated_rh.surf.gii fsaverage_rh_10.smooth.label.gii</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co">## Back to viewing with freesurfer</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="cf">for</span> hemi <span class="kw">in</span> lh rh <span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="ex">mris_convert</span> <span class="at">--annot</span> fsaverage_<span class="va">${hemi}</span>_10.smooth.label.gii inflated_<span class="va">${hemi}</span>.surf.gii ./<span class="va">${hemi}</span>.ho.smooth.annot</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Screengrabs with tksurfer. This can be reun somewhere other than
fsaverage.</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">./mkPics.sh</span></span></code></pre></div>
<ol start="9" style="list-style-type: decimal">
<li>Rename the unknowns to medial wall</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">mv</span> PicsHarvardOxford/lh_\?\?\?_med.tif PicsHarvardOxford/lh_medialwall_med.tif</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">mv</span> PicsHarvardOxford/rh_\?\?\?_med.tif PicsHarvardOxford/rh_medialwall_med.tif</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="fu">rm</span> PicsHarvardOxford/<span class="pp">*</span>_\?<span class="pp">*</span></span></code></pre></div>
<ol start="10" style="list-style-type: decimal">
<li>Finally, let the R spatial tools work their magic…</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"mkHO.R"</span><span class="op">)</span></span></code></pre></div>
<p>This creates <code>ho_atlas.Rda</code> which contains a couple of
data frames, almost ready for inclusion in ggsegExtra.</p>
</div>
<div class="section level3">
<h3 id="comments">Comments<a class="anchor" aria-label="anchor" href="#comments"></a>
</h3>
<p>I suspect something similar will be possible with tkedit, or other
viewers that are able to look at the subcortical structures. Otherwise
maximal projections after thresholding will probably suffice.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Athanasia Mo Mowinckel, Didac Vidal-Piñeiro.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
